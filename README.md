### Шаг 1. Делаем «справочник надбавок»

```sql
/* 1.1. Временная таблица-справочник */
DROP TABLE IF EXISTS #premiums;
CREATE TABLE #premiums
(   start_dt     date      NOT NULL,     -- первый день действия
    end_dt       date      NOT NULL,     -- последний день (вкл.)
    term_from    int       NOT NULL,     -- нижняя граница MATUR
    term_to      int       NOT NULL,     -- верхняя граница MATUR
    add_rate     decimal(6,4) NOT NULL   -- сама надбавка
);

/* 1.2. Заполняем: одна строка = один «пакет» (даты-диапазон × срок-диапазон)
   ↓ из твоего CASE-блока – только самые «чистые» даты и диапазоны           */
INSERT INTO #premiums (start_dt,end_dt,term_from,term_to,add_rate) VALUES
/* 02-июл-25 */
('2025-07-02','2025-07-02',  80,100,0.0181),
('2025-07-02','2025-07-02', 180,200,0.0158),
('2025-07-02','2025-07-02', 255,290,0.0103),
('2025-07-02','2025-07-02', 355,375,0.0097),
/* 01-июл-25 */
('2025-07-01','2025-07-01',  80,100,0.0196),
('2025-07-01','2025-07-01', 180,200,0.0209),
('2025-07-01','2025-07-01', 255,290,0.0153),
('2025-07-01','2025-07-01', 355,375,0.0137),
/* 30-июн-25 */
('2025-06-30','2025-06-30',  80,100,0.0186),
('2025-06-30','2025-06-30', 180,200,0.0199),
('2025-06-30','2025-06-30', 255,290,0.0141),
('2025-06-30','2025-06-30', 355,375,0.0123),
/* 27-июн-25 – 29-июн-25  (диапазон дат!) */
('2025-06-27','2025-06-29',  80,100,0.0172),
('2025-06-27','2025-06-29', 180,200,0.0190),
('2025-06-27','2025-06-29', 255,290,0.0132),
('2025-06-27','2025-06-29', 355,375,0.0113),
/* …дальше заносите остальные пакеты
   (26-июн-25, 25-июн-25, 24-июн-25, 23-июн-25, 19-июн-25–22-июн-25 и т.д.) */
;
GO
```

* **start\_dt / end\_dt** — позволяют задавать как одну дату, так и интервал
  (27 – 29 июня я уже занёс одним интервалом).
* **term\_from / term\_to** — границы `MATUR` из твоего `CASE`.
* Если для 540 дней «надбавка 0», строку просто не добавляем — тогда
  при соединении `add_rate` будет `NULL` и ты ничего не прибавишь.

---

### Шаг 2. Главный запрос + JOIN на справочник

```sql
/* 2.1. Базовая выборка договоров (твой исходный запрос) */
WITH dep AS (
    SELECT  con_id,
            dt_open,
            dt_rep,
            out_rub,
            rate_trf,
            rate_con,
            tsegmentname,
            termdays      AS matur,
            is_floatrate,
            trr_option_rate,
            prod_name_res
    FROM ALM.VW_Balance_Rest_All WITH (NOLOCK)
    WHERE dt_open BETWEEN '2025-06-01' AND '2025-06-30'
      AND dt_rep  = '2025-06-30'
      AND segment_id  = 'S01'
      AND section_name = 'Срочные'
      AND cur = '810'
      AND is_floatrate = 0                          -- фикс
      AND od_flag = 1                               -- тело
      AND out_rub IS NOT NULL
      AND prod_name_res NOT IN (
            N'Надёжный',N'Надёжный VIP',N'Надёжный премиум',
            N'Надёжный промо',N'Надёжный старт',
            N'Надёжный T2',N'Надёжный Мегафон',
            N'ДОМа надёжно',N'Всё в ДОМ',
            N'Базовый Пенсионный',N'ЮЛ срочный депозит с доср. (v2)',
            N'Стратегический',N'Долголетие'
      )
)

/* 2.2. Подмешиваем надбавку */
SELECT  d.*,
        p.add_rate,
        /* пример финальной TRF-ставки - то же, что было в CASE */
        d.rate_trf
          + ISNULL(d.trr_option_rate,0)
          + ISNULL(p.add_rate,0)      AS rate_trf_final
FROM dep AS d
LEFT JOIN #premiums AS p
  ON  d.dt_open BETWEEN p.start_dt AND p.end_dt
  AND d.matur    BETWEEN p.term_from AND p.term_to;
```

#### Что получили

| con\_id | dt\_open   | matur | rate\_trf | add\_rate  | rate\_trf\_final |
| ------- | ---------- | ----- | --------- | ---------- | ---------------- |
| …       | 2025-06-27 | 91    | 16.43 %   | **1.72 %** | 18.15 %          |
| …       | 2025-06-27 | 365   | 15.80 %   | **1.13 %** | 16.93 %          |
| …       | 2025-06-30 | 181   | …         | **1.99 %** | …                |

*Для дат/сроков без строки в `#premiums` поле `add_rate` будет `NULL`,
финальная ставка останется исходной.*

---

### Чем это лучше длинного CASE

* **Надбавки лежат отдельными строками** — легко обновить или добавить новый интервал без правки кода расчёта.
* Наглядно видно, какие диапазоны покрыты.
* `JOIN` однозначный: дата + диапазон срока.

> **Совет:** после отладки преврати `#premiums` во вспомогательную таблицу
> `ALM.dbo.trf_premiums`, которую будете пополнять бизнес-пользователи
> (или ETL-скрипт), а расчётный запрос оставите неизменным.
