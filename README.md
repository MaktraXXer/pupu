–î–∞, –∑–∞–¥–∞—á–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è—Ç–Ω–∞ –∏ –æ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª–∏–∫–∞–µ—Ç—Å—è —Å –ø—Ä–æ—à–ª–æ–π –ª–æ–≥–∏–∫–æ–π ‚Äî –Ω–æ —Ç–µ–ø–µ—Ä—å –º—ã:

‚∏ª

üìå –¶–µ–ª—å:

–ù–∞ –∫–∞–∂–¥—ã–π –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞ —Å —è–Ω–≤–∞—Ä—è 2024 –ø–æ –∏—é–Ω—å 2025:
	1.	–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∂–∏–≤—ã–µ –≤–∫–ª–∞–¥—ã –Ω–∞ –§–£-–ø—Ä–æ–¥—É–∫—Ç–∞—Ö;
	2.	–ü–æ—Å—á–∏—Ç–∞—Ç—å –∏—Ö —Å—É–º–º–∞—Ä–Ω—ã–π BALANCE_RUB –ø–æ —ç—Ç–∏–º –§–£-–≤–∫–ª–∞–¥–∞–º;
	3.	–£—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ –≤–∫–ª–∞–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ:
	‚Ä¢	–û—Ç–∫—Ä—ã—Ç—ã –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞
	‚Ä¢	–ù–µ –∑–∞–∫—Ä—ã—Ç—ã –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞ (–∏–ª–∏ –≤–æ–æ–±—â–µ –±–µ–∑ DT_CLOSE)
	‚Ä¢	BALANCE_RUB ‚â• 1

‚∏ª

‚úÖ –ì–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

import pandas as pd

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
FU_PRODUCTS = {
    '–ù–∞–¥—ë–∂–Ω—ã–π','–ù–∞–¥—ë–∂–Ω—ã–π VIP','–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
    '–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ','–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
    '–ù–∞–¥—ë–∂–Ω—ã–π T2','–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
}
START_DATE = pd.Timestamp('2024-01-01')
END_DATE   = pd.Timestamp('2025-06-30')
MIN_BAL_RUB = 1.0

# === –î–∞–Ω–Ω—ã–µ ===
df = df_sql.copy()
for c in ['DT_OPEN', 'DT_CLOSE']:
    df[c] = pd.to_datetime(df[c], errors='coerce')

df['is_fu'] = df['PROD_NAME'].isin(FU_PRODUCTS)

# === –ú–µ—Å—è—Ü—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ ===
months = pd.period_range('2024-01', '2025-06', freq='M')
rows = []

for m in months:
    month_end = m.end_time.normalize()

    # —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –§–£-–≤–∫–ª–∞–¥—ã, –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞
    df_m = df.loc[
        (df['is_fu']) &
        (df['DT_OPEN'] <= month_end) &
        ((df['DT_CLOSE'].isna()) | (df['DT_CLOSE'] > month_end)) &
        (df['BALANCE_RUB'].fillna(0) >= MIN_BAL_RUB)
    ].copy()

    n_clients = df_m['CLI_ID'].nunique()
    total_bal = df_m['BALANCE_RUB'].sum()

    rows.append([month_end.strftime('%d.%m.%Y'), n_clients, total_bal])

# === –†–µ–∑—É–ª—å—Ç–∞—Ç ===
res_df = pd.DataFrame(rows, columns=[
    '–ú–µ—Å—è—Ü',
    '–ö–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£-–≤–∫–ª–∞–¥–∞–º–∏',
    '–ü–æ—Ä—Ç—Ñ–µ–ª—å –§–£ (BALANCE_RUB)'
])
res_df.set_index('–ú–µ—Å—è—Ü', inplace=True)

print(res_df)


‚∏ª

üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:

–®–∞–≥	–û–ø–∏—Å–∞–Ω–∏–µ
1Ô∏è‚É£	–ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –¥–Ω—é –º–µ—Å—è—Ü–∞ —Å 2024-01 –ø–æ 2025-06
2Ô∏è‚É£	–§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –§–£-–≤–∫–ª–∞–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ:
‚ÄÉ‚ÄÉ- –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞	
‚ÄÉ‚ÄÉ- –∏ –Ω–µ –±—ã–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞	
‚ÄÉ‚ÄÉ- –∏ –∏–º–µ—é—Ç BALANCE_RUB ‚â• 1	
3Ô∏è‚É£	–°—á–∏—Ç–∞–µ–º:
‚ÄÉ‚ÄÉ- —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö CLI_ID –≤ —ç—Ç–æ–π –≤—ã–±–æ—Ä–∫–µ	
‚ÄÉ‚ÄÉ- —Å—É–º–º—É BALANCE_RUB	
4Ô∏è‚É£	–§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É: —Å—Ç—Ä–æ–∫–∏ ‚Äî –º–µ—Å—è—Ü, —Å—Ç–æ–ª–±—Ü—ã ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å—É–º–º–∞


‚∏ª

üîÑ –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (–±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫):

                     –ö–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£-–≤–∫–ª–∞–¥–∞–º–∏  –ü–æ—Ä—Ç—Ñ–µ–ª—å –§–£ (BALANCE_RUB)
31.01.2024                               752                 1.04e+09
29.02.2024                               810                 1.08e+09
...
30.06.2025                               894                 1.23e+09


‚∏ª

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å: –≥—Ä–∞—Ñ–∏–∫, —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel, —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º ‚Äî —Å–∫–∞–∂–∏, –¥–æ–±–∞–≤–ª—é.
