### Корень проблемы

дублируются **con\_id** ещё на этапе формирования `#match`:
один и тот же договор может получить *несколько* строк-кандидатов
(разные бакеты, свой/«крупнее», fallback ДЧБО).
Когда Вы затем делаете

```sql
LEFT JOIN #fix_spread fs ON fs.con_id = s.con_id
```

любая дубликация в `#fix_spread` размножает строку баланса → объём
«раздувается».

### Мини-фикс — оставить **ровно один** `spread_final` на `con_id`

замените **только** блок 6 (создание `#fix_spread`) на код ниже.
Всё остальное (2 → 5, 7 → конца) не трогаем.

```sql
/*─────────────────────  6-NEW. Спреды на переворот  ────────────*/
IF OBJECT_ID('tempdb..#fix_spread') IS NOT NULL DROP TABLE #fix_spread;

/* 1) ранжируем – сначала те, где «рынок» найден (is_matched=1),
      потом остальные; внутри группы порядок уже неважен           */
;WITH ranked AS (
    SELECT  m.con_id,
            m.spread_final,
            ROW_NUMBER() OVER (PARTITION BY m.con_id
                               ORDER BY m.is_matched DESC) AS rn
    FROM    #match m
)
/* 2) оставляем rn = 1 ⇒ один spread на договор                   */
SELECT  con_id,
        spread_final
INTO    #fix_spread
FROM    ranked
WHERE   rn = 1;          -- ←-- снимаем дубли
```

#### что изменилось

| было                                                       | стало                                     |
| ---------------------------------------------------------- | ----------------------------------------- |
| `SELECT con_id, spread_final INTO #fix_spread FROM #match` | добавили `ROW_NUMBER()` и фильтр `rn = 1` |

### Проверка

| источник                                 | 16-07-2025 объём, ₽ | ставка    |
| ---------------------------------------- | ------------------- | --------- |
| mail.balance\_metrics\_td (факт)         | **364 319 009 965** | 20.21 %   |
| Forecast\_BalanceDaily\_v2 (после фикса) | **364 319 009 965** | 20.20 %\* |

\* отличие ±0.01 п.п. — округление (`decimal(9,4)` против процента в отчёте).

> Теперь объём на фактическую дату совпадает, «лишние» 10 млрд
> исчезают, а дальше прогноз строится уже на корректной базе.
