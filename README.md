Ниже ― «заготовка» на pandas, полностью повторяющая вашу логику, только вместо колонки **сальдо** использует
`NET_SUM_TRANS_total`, а нужные фильтры заданы ровно так, как вы описали.

```python
import numpy as np
import pandas as pd
import math, re

###############################################################################
# 0.  Исходные данные ― DataFrame `df` (прочитали CSV / Excel и т.д.)
###############################################################################
# df = pd.read_excel('raw.xlsx', parse_dates=['dt_rep'])   # пример чтения

###############################################################################
# 1.  Фильтр: direction_type = «Переводы себе»  и  partner_code = '-'
#     Остальные поля («(Все)») не трогаем
###############################################################################
flt = (
    (df['direction_type'] == 'Переводы себе')
    & (df['partner_code']   == '-')
)
data = df.loc[flt].copy()

###############################################################################
# 2.  Неделя ‒ удобная «человеческая» метка в формате дд–дд МММ
#     (можно заменить на rep_W, если он вас устраивает)
###############################################################################
# если в датафрейме уже есть готовая строка rep_W вида '2025.01.16-2025.01.22',
# то просто:  data['Неделя'] = data['rep_W']
# Ниже ‒ вариант «от даты»:
data['week_start'] = data['dt_rep'].dt.to_period('W').apply(lambda p: p.start_time)
data['week_end']   = data['week_start'] + pd.Timedelta(days=6)
RU_MON = ['янв', 'фев', 'мар', 'апр', 'май', 'июн',
          'июл', 'авг', 'сен', 'окт', 'ноя', 'дек']
data['Неделя'] = (data['week_start'].dt.day.astype(str).str.zfill(2) + '-' +
                  data['week_end'].dt.day.astype(str).str.zfill(2)   + ' ' +
                  data['week_end'].dt.month.map(lambda m: RU_MON[m-1]))

###############################################################################
# 3.  Считаем недельное сальдо по каждому банку
###############################################################################
wb = (data
      .groupby(['Неделя', 'bank_name_main'], as_index=False)['NET_SUM_TRANS_total']
      .sum()
      .rename(columns={'NET_SUM_TRANS_total': 'сальдо'}))

###############################################################################
# 4.  «Заметные» банки  — те, у кого |сальдо| ≥ THR хотя бы один раз.
#     Порог можно менять (по умолчанию 100 млн).
###############################################################################
THR = 1e8                # 100 000 000
wb['sal_big'] = wb['сальдо'].where(wb['сальдо'].abs() >= THR, np.nan)
BANKS_BIG = wb.loc[wb['sal_big'].notna(), 'bank_name_main'].unique()

###############################################################################
# 5.  Пивот: недели × банки-«звёзды», значение = sal_big (иначе NaN)
###############################################################################
pivot = (wb[wb['bank_name_main'].isin(BANKS_BIG)]
         .pivot(index='Неделя',
                columns='bank_name_main',
                values='sal_big')
         .sort_index())

###############################################################################
# 6.  Колонка «Остальные банки» = общее недельное сальдо − сумма отображённых
###############################################################################
total_week = wb.groupby('Неделя')['сальдо'].sum()
pivot['Остальные банки'] = total_week - pivot.fillna(0).sum(axis=1)

###############################################################################
# 7.  Красиво выводим: перевод в млрд с двумя знаками, NaN не трогаем
###############################################################################
pivot_fmt = pivot.applymap(
    lambda x: np.nan if pd.isna(x) else round(x/1e6, 2)   # → млн; поменяйте /1e9 для млрд
)

pd.set_option('display.max_columns', None)
print('\n=== Сальдо (|≥100 млн|) по неделям, млн руб. ===')
print(pivot_fmt.to_string())
pd.reset_option('display.max_columns')

###############################################################################
# 8.  Сохраняем в Excel / CSV
###############################################################################
pivot_fmt.to_excel('сальдо_по_банкам_недели.xlsx')
# pivot_fmt.to_csv('сальдо_по_банкам_недели.csv')
```

### Что можно оперативно поменять

| Параметр          | За что отвечает              | Типичное изменение                                  |
| ----------------- | ---------------------------- | --------------------------------------------------- |
| `THR`             | порог «заметности» банка     | `1.5e8`, `5e7`, `0` (показать всех)                 |
| `Неделя`          | метка периода                | заменить на `data['rep_W']`, если строка уже готова |
| `round(x/1e6, 2)` | перевод в млн и число знаков | `/1e9` → млрд, `3` → три знака                      |

Код можно вставлять как есть: достаточно заменить имя датафрейма `df`, если у вас другое, и указать путь к файлу при чтении / сохранении.




```python
import pandas as pd
import numpy as np

# Загрузка данных (предполагается, что данные уже загружены в DataFrame df)
# df = pd.read_excel('ваши_данные.xlsx')

# Применение фильтров
filtered = df[
    (df['direction_type'] == 'Переводы себе') &
    (df['partner_code'] == '-')
]

# Группировка по неделе и банку с суммированием сальдо
grouped = filtered.groupby(['rep_W', 'bank_name_main'], as_index=False)['NET_SUM_TRANS_total'].sum()

# Определение банков с большим сальдо (порог 100 млн)
THR = 100_000_000
bank_max = grouped.groupby('bank_name_main')['NET_SUM_TRANS_total'].apply(lambda x: x.abs().max())
BANKS_BIG = bank_max[bank_max >= THR].index.tolist()

# Добавление форматированной даты и метки недели
grouped[['start_str', 'end_str']] = grouped['rep_W'].str.split('-', expand=True)
grouped['w_end'] = pd.to_datetime(grouped['end_str'], format='%Y.%m.%d')
RU_MON = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек']
grouped['Неделя'] = grouped['w_end'].apply(lambda x: f"{x.day:02d}-{(x + pd.DateOffset(days=6)).day:02d} {RU_MON[x.month-1]}")

# Создание столбца с отфильтрованным сальдо
grouped['saldo_filtered'] = np.where(
    (grouped['bank_name_main'].isin(BANKS_BIG)) & 
    (grouped['NET_SUM_TRANS_total'].abs() >= THR),
    grouped['NET_SUM_TRANS_total'],
    np.nan
)

# Создание сводной таблицы
pivot = grouped.pivot(index='Неделя', columns='bank_name_main', values='saldo_filtered')

# Добавление колонки "Остальные банки"
total_per_week = grouped.groupby('Неделя')['NET_SUM_TRANS_total'].sum()
pivot['Остальные банки'] = total_per_week - pivot.fillna(0).sum(axis=1)

# Форматирование и сохранение
pivot_formatted = pivot.applymap(lambda x: f"{round(x/1e6, 2)}M" if pd.notnull(x) else np.nan)
pivot_formatted.to_excel('сальдо_по_неделям_и_банкам.xlsx')

print("Таблица успешно сохранена в файл 'сальдо_по_неделям_и_банкам.xlsx'")
``` 

Этот код:
1. Фильтрует данные по заданным условиям
2. Группирует сальдо по неделям и банкам
3. Определяет банки с большими транзакциями
4. Создает удобный формат отображения недель
5. Формирует итоговую таблицу с наном для малых значений
6. Добавляет колонку для остальных банков
7. Сохраняет результат в Excel с форматированием в миллионах
