### Как посчитать средневзвешенную ставку за неделю

(аналог **СУММПРОИЗВ + условия**, т.е. «SUMPRODUCTIFS»)

#### 1. Структура данных

| Колонка    | Пример    | Имя диапазона (необязательно) |
| ---------- | --------- | ----------------------------- |
| **Дата**   | A2\:A1000 | `Дата`                        |
| **Объём**  | B2\:B1000 | `Объем`                       |
| **Ставка** | C2\:C1000 | `Ставка`                      |

В сводной (недельной) таблице:

| E (начало недели) | F (конец недели) | G (итоговый объём) | H (средневзвеш. ставка) |
| ----------------- | ---------------- | ------------------ | ----------------------- |
| **E2**            | **F2**           | **G2**             | **H2**                  |

---

#### 2. Формулы (классический Excel ≤ 2021)

```excel
G2  (сумма объёма)
=СУММЕСЛИМН(Объем; Дата; ">="&E2; Дата; "<="&F2)

H2  (средневзвешенная ставка)
=СУММПРОИЗВ((Дата>=E2)*(Дата<=F2)*Объем*Ставка) /
 СУММЕСЛИМН(Объем; Дата; ">="&E2; Дата; "<="&F2)
```

* `(Дата>=E2)*(Дата<=F2)` — маска 0/1 для нужной недели.
* Числитель — сумма «Объём × Ставка» по этой маске.
* Знаменатель — сумма объёмов той же недели.

> Если не используете именованные диапазоны, подставьте прямые ссылки
> `A$2:A$1000`, `B$2:B$1000`, `C$2:C$1000`.

---

#### 3. Формула с LET (Microsoft 365)

```excel
=LET(
  маска; (Дата>=E2)*(Дата<=F2);
  v;     SUMPRODUCT(маска*Объем);          /* объём недели  */
  r;     SUMPRODUCT(маска*Объем*Ставка);   /* вес-сумма     */
  r/v                                    ) /* средневзвеш.  */
```

---

#### 4. Вариант одной строкой (динамические массивы 365)

```excel
=SUM(FILTER(Объем*Ставка; (Дата>=E2)*(Дата<=F2))) /
 SUM(FILTER(Объем;        (Дата>=E2)*(Дата<=F2)))
```

---

### Итог

* **Объём недели** — обычный `СУММЕСЛИМН`.
* **Ставка** = `Σ(Объём×Ставка) / Σ(Объём)` по той же маске.
* Это и есть «SUMPRODUCTIFS»: `СУММПРОИЗВ(маска*Вес*Цена) / СУММПРОИЗВ(маска*Вес)`.

Формулы не требуют **Ctrl + Shift + Enter** и корректно пересчитываются при изменении дат или значений.
