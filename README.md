### Предлагаемое решение

Ниже - пример T-SQL-скрипта, который создаёт новую витрину **WORK.vSpread\_TR\_OIS\_UL\_5d**.
Она берёт данные из вашей существующей витрины **WORK.vGroupDepositInterestsRate\_dtStart\_UL\_matur\_pdr\_fo**,
накладывает все нужные фильтры, считает:

* **WtdSpread\_TR\_OIS** – однодневный средневзвешенный (по объёму × срочности) спред «ТС\* – OIS»;
* **WtdSpread\_TR\_OIS\_Avg5d** – скользящее среднее этого спреда за последние 5 календарных рабочих дат;
* отдаёт только последние пять дат (последнюю доступную + четыре предшествующие).

```sql
USE ALM_TEST;
GO
------------------------------------------------------------------
-- удаляем старую версию витрины, если была
------------------------------------------------------------------
IF OBJECT_ID('WORK.vSpread_TR_OIS_UL_5d', 'V') IS NOT NULL
    DROP VIEW WORK.vSpread_TR_OIS_UL_5d;
GO
------------------------------------------------------------------
-- создаём витрину
------------------------------------------------------------------
SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;
GO

CREATE VIEW WORK.vSpread_TR_OIS_UL_5d
AS
WITH base AS (   ----------------------------------------------------------------
                -- 1. Берём только нужные сделки
                ----------------------------------------------------------------
    SELECT
        g.[Date],                                     -- дата сделки
        (g.[MonthlyCONV_TransfertRate_MOD] 
         - g.[MonthlyCONV_OIS])           AS Spread_TR_OIS,  -- сам спред
        g.[BALANCE_RUB],                              -- объём
        g.[MATUR]                                     -- срочность (дней)
    FROM   WORK.vGroupDepositInterestsRate_dtStart_UL_matur_pdr_fo g
    WHERE  g.[CLI_SUBTYPE]       = 'ЮЛ'            -- тип клиента: ЮЛ
      AND  g.[SEG_NAME]          = 'all segment'   -- сегмент: все
      AND  g.[TYPE]              = 'Начало день ко дню'        -- «новые» сделки
      AND  g.[IS_FINANCE_LCR]    = 'all FINANCE_LCR'
      AND  g.[IS_PDR]            = 'all PDR'
      AND  g.[TERM_GROUP]       <> 'all termgroup' -- исключаем агрегирующий бакет
      AND  g.[MATUR]            <= 30              -- срок до 30 дней
),
daily AS (        --------------------------------------------------------------
                  -- 2. Считаем средневзвешенный спред по каждой дате
                  --------------------------------------------------------------
    SELECT
        b.[Date],
        CAST( SUM(b.Spread_TR_OIS * b.BALANCE_RUB * b.MATUR)
              / NULLIF(SUM(b.BALANCE_RUB * b.MATUR),0)
              AS DECIMAL(18,8) )     AS WtdSpread_TR_OIS
    FROM  base b
    GROUP BY b.[Date]
),
last5 AS (        --------------------------------------------------------------
                  -- 3. Оставляем только последние 5 доступных дат
                  --------------------------------------------------------------
    SELECT TOP (5) *
    FROM   daily
    ORDER  BY [Date] DESC
),
avg5  AS (        --------------------------------------------------------------
                  -- 4. Считаем 5-дневное среднее (одна строка)
                  --------------------------------------------------------------
    SELECT
        MAX([Date])                             AS MaxDate,
        CAST(AVG(WtdSpread_TR_OIS) AS DECIMAL(18,8)) AS Avg5d
    FROM last5
)
-------------------------------------------------------------------------------
-- 5. Итоговый вывод: 5 дат + в каждом ряду тот же 5-дневный средняк
-------------------------------------------------------------------------------
SELECT
    l.[Date],
    l.WtdSpread_TR_OIS,
    a.Avg5d            AS WtdSpread_TR_OIS_Avg5d
FROM last5 l
CROSS JOIN avg5 a      -- одно и то же среднее повторяем для всех 5 строк
ORDER BY l.[Date];     -- возрастающая сортировка
GO
```

#### Что делает скрипт

| Блок      | Описание                                                                                                                |
| --------- | ----------------------------------------------------------------------------------------------------------------------- |
| **base**  | Накладывает фильтры: ЮЛ, «all segment», «Начало день ко дню», срочность ≤ 30 дн., TERM\_GROUP ≠ “all termgroup” и т. д. |
| **daily** | Считает средневзвешенный спред за каждый день. Вес = BALANCE\_RUB × MATUR.                                              |
| **last5** | Берёт 5 самых свежих дат (если внутри есть выходные, они просто пропущены).                                             |
| **avg5**  | Среднее от этих пяти значений – именно то, что вы раньше вручную высчитывали в Excel.                                   |
| Итог      | Показываем 5 строк (даты ↑), в каждой колонка со spred-днём и общим 5-дневным средним.                                  |

> **Как использовать**
>
> * За 5-дневным средним берите колонку **WtdSpread\_TR\_OIS\_Avg5d** на самой последней дате (она же MaxDate).
> * Если нужно только 1 строку с последней датой + 5-дн. средним, просто добавьте во внешний запрос `WHERE [Date] = (SELECT MAX([Date]) FROM WORK.vSpread_TR_OIS_UL_5d)`.

---

#### Почему так удобно

* **Excel больше не нужен** для промежуточных сумм – витрина уже отдаёт готовую агрегацию.
* При появлении новой даты витрина автоматически «сдвинется» и всегда покажет актуальные пять рабочих дней.
* При необходимости легко добавить дополнительные поля (объём, баланс и т. п.) – достаточно расширить подзапрос *daily*.

Если понадобится вариант, который возвращает **только одну** строку (последняя дата + 5-дневный средняк), дайте знать – пришлю облегченную версию.
