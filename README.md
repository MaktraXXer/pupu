### Почему формула «ломается», когда ссылаемся на другой лист

1. **В `СУММПРОИЗВ` каждая ссылка должна повторять имя листа.**
   Excel не «распространяет» его автоматически внутри скобок
   `(A:A>=E2)` → `(ЛистДанные!A:A>=E2)`.

2. **Размер всех диапазонов должен совпадать.**
   Если один столбец обрезан (например, `A2:A1000`), а другой – `B:B`, получится ошибка.

3. **Полные столбцы (`A:A`) в `СУММПРОИЗВ` часто дают #ЗНАЧ!,** особенно в старых версиях.
   Безопаснее задать «разумный» диапазон (например, до 100 000 строк) или оформить исходную таблицу как **Excel-таблицу** (Ctrl + T) и пользоваться структурированными ссылками.

---

## Рабочий пример (русская локаль)

Допустим, все ежедневные записи лежат на листе **Данные**:

| Столбец | Диапазон               |
| ------- | ---------------------- |
| Дата    | `Данные!$A$2:$A$10000` |
| Объём   | `Данные!$B$2:$B$10000` |
| Ставка  | `Данные!$C$2:$C$10000` |

А на листе **Сводка** в строке 2 находятся:

* **E2** – начало недели
* **F2** – конец недели

### 1  Сумма объёма недели

```excel
=СУММЕСЛИМН(Данные!$B$2:$B$10000;
            Данные!$A$2:$A$10000;">="&E2;
            Данные!$A$2:$A$10000;"<="&F2)
```

### 2  Средневзвешенная ставка

```excel
=СУММПРОИЗВ( (Данные!$A$2:$A$10000>=E2)*
             (Данные!$A$2:$A$10000<=F2)*
             Данные!$B$2:$B$10000*
             Данные!$C$2:$C$10000 )
/
СУММЕСЛИМН(Данные!$B$2:$B$10000;
           Данные!$A$2:$A$10000;">="&E2;
           Данные!$A$2:$A$10000;"<="&F2)
```

*Верхняя формула – числитель: «объём × ставка» только для строк недели.*
*Нижняя – тот же объём, чтобы поделить и получить средневзвешенное.*

---

## Современный вариант (Microsoft 365, структурированные ссылки)

1. Превратите исходную табличку на листе **Данные** в Excel-таблицу, назовите её **tblTX**.
   Тогда столбцы будут `tblTX[Дата]`, `tblTX[Объем]`, `tblTX[Ставка]`.

2. В ячейке **H2** листа Сводка:

```excel
=LET(
    маска; (tblTX[Дата]>=E2)*(tblTX[Дата]<=F2);
    вес;   tblTX[Объем];
    ставка;tblTX[Ставка];
    СУММПРОИЗВ(маска*вес*ставка) / СУММПРОИЗВ(маска*вес)
)
```

Преимущества:

* не нужно помнить абсолютные адреса;
* добавление строк в таблицу не требует правки формулы;
* читается легче.

---

### Что делать, если всё равно #ЗНАЧ!

1. Проверьте разделители: в русской версии Excel – **точка с запятой `;`**, не запятая.
2. Убедитесь, что ячейки **E2 / F2** содержат истинные даты (форматните в «Числовой» – должно показаться большое число).
3. Не используйте **разные** длины диапазонов внутри `СУММПРОИЗВ`.
4. Если строк много, а версия Excel старая, ограничьте диапазон не более 65 000 строк (до Excel 2007).

С учётом этих правил формула корректно посчитает и объём, и средневзвешенную ставку даже при ссылках на другой лист.
