üî• –û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å —è—Å–Ω–æ:
—Ç–µ–±–µ –Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —à–∞–≥ 1 —Å –¥–≤—É–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:

‚∏ª

‚úÖ –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–µ–ø–µ—Ä—å
	1.	–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—Ç–∫–∞:
–µ—Å–ª–∏ —Ç—ã —É–∫–∞–∑—ã–≤–∞–µ—à—å –¥–∏–∞–ø–∞–∑–æ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä >3,
—Ç–æ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –≥—Ä–∞—Ñ–∏–∫–µ –≤—Å—ë, —á—Ç–æ –ø—Ä–∞–≤–µ–µ 3, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ–æ–±—â–µ ‚Äî
–Ω–∏ —Ç–æ—á–∫–∏, –Ω–∏ –∫—Ä–∏–≤–∞—è, –Ω–∏ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞.
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è <-2 (–≤—Å—ë –ª–µ–≤–µ–µ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
–∏ –¥–ª—è -1..1 (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞).
‚û§ –¢–æ –µ—Å—Ç—å, –º—ã –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫—Ä–∏–≤–∞—è+—Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ ‚Äú—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö‚Äù –∑–æ–Ω–∞—Ö,
–∏—Å–∫–ª—é—á–∞—è –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–µ—Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–º—É–ª—ã.
–ù–æ –¥–∞–Ω–Ω—ã–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ —Ä–∏—Å—É—é—Ç—Å—è.
	2.	–î–æ–±–∞–≤–∏—Ç—å –≤ summary.txt —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞,
–Ω–∞–ø—Ä–∏–º–µ—Ä:

h=1: <-3; >5
h=2: -1..1
h=3: –Ω–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π



‚∏ª

üíæ –ù–∏–∂–µ ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ (v2): ¬´–æ–±—Ä–µ–∑–∫–∞, –Ω–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∞¬ª

# -*- coding: utf-8 -*-
"""
STEP 1 ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è S-–∫—Ä–∏–≤—ã—Ö (–æ–±—Ä–µ–∑–∫–∞ –Ω–µ—Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤).

–ù–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è–µ–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö.
–ü—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—á–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–æ–Ω—ã.
"""

import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.optimize import minimize
from datetime import datetime
import warnings

warnings.filterwarnings("ignore", category=FutureWarning)
warnings.filterwarnings("ignore", category=UserWarning)
plt.rcParams["axes.formatter.useoffset"] = False


# ‚îÄ‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def _ensure_dir(p: str) -> str:
    os.makedirs(p, exist_ok=True)
    return p


def _f_from_betas(b, x):
    return (
        b[0]
        + b[1] * np.arctan(b[2] + b[3] * x)
        + b[4] * np.arctan(b[5] + b[6] * x)
    )


def _fit_arctan_unconstrained(x, y, w,
                              start=(0.2, 0.05, -2.0, 2.2, 0.07, 2.0, 0.2)):
    x, y, w = np.asarray(x, float), np.asarray(y, float), np.asarray(w, float)
    if len(x) < 5:
        return np.array([np.nan] * 7)
    w = np.where(np.isfinite(w) & (w > 0), w, 0.0)
    w = (w / w.sum()) if w.sum() > 0 else np.ones_like(w) / len(w)

    def f(b, xx): return (b[0]
                          + b[1] * np.arctan(b[2] + b[3] * xx)
                          + b[4] * np.arctan(b[5] + b[6] * xx))

    def obj(b): return np.sum(w * (y - f(b, x)) ** 2)

    bounds = [[-np.inf, np.inf], [0, np.inf], [-np.inf, 0], [0, 4],
              [0, np.inf], [0, np.inf], [0, 1]]
    res = minimize(obj, start, bounds=bounds, method="SLSQP", options={"ftol": 1e-9})
    return res.x


def _aggregate_points(df_raw: pd.DataFrame) -> pd.DataFrame:
    df = df_raw[(df_raw["stimul"].notna()) &
                (pd.to_numeric(df_raw["refin_rate"], errors="coerce") > 0) &
                (pd.to_numeric(df_raw["con_rate"],  errors="coerce") > 0)].copy()

    grp = df.groupby(["age_group_id", "stimul"], as_index=False).agg(
        premat_sum=("premat_payment", "sum"),
        od_sum=("od_after_plan", "sum")
    )
    cpr = np.where(
        grp["od_sum"] <= 0, 0.0,
        1.0 - np.power(1.0 - (grp["premat_sum"] / grp["od_sum"]), 12.0)
    )

    pts = pd.DataFrame({
        "LoanAge": pd.to_numeric(grp["age_group_id"], errors="coerce").astype("Int64"),
        "Incentive": pd.to_numeric(grp["stimul"], errors="coerce"),
        "CPR": cpr,
        "TotalDebtBln": grp["od_sum"] / 1e9
    }).dropna(subset=["LoanAge", "Incentive", "CPR", "TotalDebtBln"])
    pts = pts[pts["TotalDebtBln"] > 0]
    return pts.reset_index(drop=True)


def _filter_outside_ranges(df: pd.DataFrame, h: int, ranges):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã."""
    if not ranges:
        return df
    mask = np.ones(len(df), dtype=bool)
    for lo, hi in ranges:
        mask &= ~((df["LoanAge"] == h) &
                  (df["Incentive"] >= lo) &
                  (df["Incentive"] <= hi))
    return df[mask]


def _show_age_plot_cut(pts_h: pd.DataFrame, h: int, b, allowed_ranges):
    """–†–∏—Å—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Å –æ–±—Ä–µ–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∑–æ–Ω."""
    fig, axL = plt.subplots(figsize=(9, 5))
    axR = axL.twinx()

    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –∑–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–∫–ª—é—á–µ–Ω—ã
    if not allowed_ranges:
        allowed_ranges = [(-np.inf, np.inf)]

    colors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#9467bd"]

    for idx, (lo, hi) in enumerate(allowed_ranges):
        sub = pts_h[(pts_h["Incentive"] >= lo) & (pts_h["Incentive"] <= hi)]
        if sub.empty:
            continue

        w = sub["TotalDebtBln"].to_numpy(float)
        s = 30 + 100 * np.sqrt(np.clip(w, 0, None) / (w.max() if w.max() > 0 else 1.0))
        axL.scatter(sub["Incentive"], sub["CPR"],
                    s=s, alpha=0.4, color=colors[idx % len(colors)], label=f"zone {idx+1}")

        xg = np.linspace(sub["Incentive"].min(), sub["Incentive"].max(), 200)
        axL.plot(xg, _f_from_betas(b, xg),
                 color=colors[idx % len(colors)], lw=2.3)

        axR.bar(sub["Incentive"], sub["TotalDebtBln"],
                width=0.18, color=colors[idx % len(colors)], alpha=0.25)

    axL.grid(ls="--", alpha=0.3)
    axL.set_xlabel("Incentive, –ø.–ø.")
    axL.set_ylabel("CPR, –¥–æ–ª–∏/–≥–æ–¥")
    axR.set_ylabel("TotalDebtBln, –º–ª—Ä–¥ —Ä—É–±.")
    axL.set_title(f"h={h} (–æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫)")
    plt.show()
    return fig


# ‚îÄ‚îÄ‚îÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def run_interactive_cut(
    df_raw_program: pd.DataFrame,
    out_root: str,
    program_name: str = "UNKNOWN"
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –Ω–µ—Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤."""
    pts = _aggregate_points(df_raw_program)
    if pts.empty:
        raise RuntimeError("–ù–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.")

    ts_dir = _ensure_dir(os.path.join(
        out_root, datetime.now().strftime("%Y-%m-%d_%H-%M-%S")))
    by_age_dir = _ensure_dir(os.path.join(ts_dir, "by_age"))

    ignored_records, before_summary = [], []
    excluded_ranges = {}  # h -> [(lo,hi), ...]

    ages = sorted(pts["LoanAge"].dropna().unique().astype(int).tolist())

    for h in ages:
        pts_h = pts[pts["LoanAge"] == h].copy()
        uniq = np.sort(pts_h["Incentive"].unique())
        step = np.median(np.diff(uniq)) if len(uniq) > 1 else np.nan

        before_summary.append({
            "LoanAge": h, "min": float(uniq.min()), "max": float(uniq.max()),
            "step_med": float(step) if np.isfinite(step) else np.nan,
            "n_bins": int(len(uniq))
        })

        b = _fit_arctan_unconstrained(
            pts_h["Incentive"], pts_h["CPR"], pts_h["TotalDebtBln"])

        print(f"\n=== AGE {h} ===")
        print(f"Stimulus –¥–∏–∞–ø–∞–∑–æ–Ω: {uniq.min():.2f} ‚Üí {uniq.max():.2f}, —à–∞–≥ ‚âà {step:.2f}")
        _show_age_plot_cut(pts_h, h, b, allowed_ranges=[(-np.inf, np.inf)])

        excluded_ranges[h] = []

        while True:
            rule = input("–í–≤–µ–¥–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –∏—Å–∫–ª—é—á–µ–Ω–∏—è ('<-3', '>4', '-2..3') "
                         "–∏–ª–∏ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è: ").strip()
            if not rule:
                break

            try:
                if rule.startswith("<"):
                    hi = float(rule[1:]); lo = -np.inf
                elif rule.startswith(">"):
                    lo = float(rule[1:]); hi = np.inf
                elif ".." in rule:
                    a, bnd = rule.split("..")
                    lo, hi = float(a), float(bnd)
                else:
                    print("–ü—Ä–∏–º–µ—Ä: <-3 | >4 | -2..3"); continue
            except ValueError:
                print("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞"); continue

            conf = input("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞? (y/n): ").strip().lower()
            if conf == "y":
                excluded_ranges[h].append((lo, hi))
                ignored_records.append({
                    "LoanAge": h,
                    "Incentive_range": f"{lo}..{hi}",
                    "Reason": "cut from visualization"
                })
                print(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: {lo}..{hi}")
            else:
                print("–û—Ç–º–µ–Ω–∞.")

        # –≤—ã—á–∏—Å–ª—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–æ–Ω—ã = –≤—Å—ë, —á—Ç–æ –≤–Ω–µ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
        all_min, all_max = uniq.min(), uniq.max()
        allowed = []
        last = all_min
        for (lo, hi) in sorted(excluded_ranges[h]):
            if lo > last:
                allowed.append((last, lo))
            last = hi
        if last < all_max:
            allowed.append((last, all_max))

        # —Ä–∏—Å—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
        fig = _show_age_plot_cut(pts_h, h, b, allowed)
        fig_path = os.path.join(by_age_dir, f"age_{h}.png")
        fig.savefig(fig_path, dpi=300)
        plt.close(fig)

    # ‚îÄ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    pts.to_excel(os.path.join(ts_dir, "points_full.xlsx"), index=False)
    pd.DataFrame(ignored_records).to_excel(
        os.path.join(ts_dir, "ignored_bins.xlsx"), index=False)

    # summary.txt —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
    with open(os.path.join(ts_dir, "summary.txt"), "w", encoding="utf-8") as f:
        f.write(f"–ü—Ä–æ–≥—Ä–∞–º–º–∞: {program_name}\n")
        f.write("==== –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å—Ç–∏–º—É–ª–æ–≤ (min/max/step) ====\n")
        f.write(pd.DataFrame(before_summary).to_string(index=False))
        f.write("\n\n==== –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã ====\n")
        for h, rngs in excluded_ranges.items():
            if rngs:
                lst = "; ".join([f"{a}..{b}" for a, b in rngs])
            else:
                lst = "–Ω–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π"
            f.write(f"h={h}: {lst}\n")

    print("\n‚úÖ –®–ê–ì 1 –∑–∞–≤–µ—Ä—à—ë–Ω (–æ–±—Ä–µ–∑–∫–∞).")
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {ts_dir}")
    print("  ‚Ä¢ points_full.xlsx")
    print("  ‚Ä¢ ignored_bins.xlsx")
    print("  ‚Ä¢ summary.txt ‚Äî —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏")
    print("  ‚Ä¢ by_age/*.png ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏ —Å –æ–±—Ä–µ–∑–∫–æ–π")

    return {"output_dir": ts_dir, "excluded_ranges": excluded_ranges}


‚∏ª

üß≠ –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞

result = run_interactive_cut(
    df_raw_program=df_raw_program,
    out_root=r"C:\Users\mi.makhmudov\Desktop\SCurve_step1",
    program_name="–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"
)


‚∏ª

–•–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –¥–æ–±–∞–≤–∏–ª –≤ —ç—Ç—É –≤–µ—Ä—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ GIF-–∞–Ω–∏–º–∞—Ü–∏–∏ (–≤—Å—ë –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–¥—Ä—è–¥, –∫–∞–∫ ‚Äúscroll-through‚Äù –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–∏—Å—Ç–∞—Ç—å –ø–æ–∫–æ–ª–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥)?
