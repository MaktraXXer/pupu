–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –≤—Å—ë –∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —è—Å–Ω–æ:

‚∏ª

‚úÖ –£—Ç–æ—á–Ω—ë–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é –∫–∞–∫ —Ç–µ—Ö–∑–∞–¥–∞–Ω–∏–µ):

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ —Å —è–Ω–≤–∞—Ä—è 2024 –ø–æ –∏—é–Ω—å 2025:
	1.	–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî —Ç–µ—Ö, —É –∫–æ–≥–æ –ø–µ—Ä–≤—ã–π –≤–∫–ª–∞–¥ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ.
	2.	–†–∞–∑–±–∏—Ç—å —ç—Ç–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞:
	‚Ä¢	–ù–æ–≤—ã–µ —Å –§–£ (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤—Ö–æ–¥–∏—Ç –≤ FU_PRODUCTS)
	‚Ä¢	–ù–æ–≤—ã–µ –Ω–µ —Å –§–£ (–æ—Å—Ç–∞–ª—å–Ω—ã–µ)
	3.	–ü–æ—Å—á–∏—Ç–∞—Ç—å –∂–∏–≤–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å —ç—Ç–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–æ–Ω–µ—Ü —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (BALANCE_RUB), –Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ –≤–∫–ª–∞–¥–∞–º, –∫–æ—Ç–æ—Ä—ã–µ:
	‚Ä¢	–±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ,
	‚Ä¢	–∏ –∂–∏–≤—ã –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞ (–∞ –Ω–µ –Ω–∞ SNAP_DATE),
	‚Ä¢	–∏ –∏–º–µ—é—Ç BALANCE_RUB ‚â• 1.

‚∏ª

‚öôÔ∏è –ü–æ–ª–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç

import pandas as pd

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
FU_PRODUCTS = {
    '–ù–∞–¥—ë–∂–Ω—ã–π','–ù–∞–¥—ë–∂–Ω—ã–π VIP','–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
    '–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ','–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
    '–ù–∞–¥—ë–∂–Ω—ã–π T2','–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
}
START_DATE = pd.Timestamp('2024-01-01')
END_DATE   = pd.Timestamp('2025-06-30')
MIN_BAL_RUB = 1.0

# === –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ===
df = df_sql.copy()
for c in ['DT_OPEN', 'DT_CLOSE']:
    df[c] = pd.to_datetime(df[c], errors='coerce')

# –£–±–∏—Ä–∞–µ–º –±–µ—Å—Å—Ä–æ—á–Ω—ã–µ –∏ "–±—ã—Å—Ç—Ä—ã–µ" –≤–∫–ª–∞–¥—ã (‚â§ 2 –¥–Ω–µ–π)
bad_fast = (df['DT_CLOSE'].isna()) | ((df['DT_CLOSE'] - df['DT_OPEN']).dt.days <= 2)
df = df[~bad_fast].copy()
df['is_fu'] = df['PROD_NAME'].isin(FU_PRODUCTS)

# === –ü–µ—Ä–≤—ã–π –≤–∫–ª–∞–¥ –∫–ª–∏–µ–Ω—Ç–∞ ===
first = (df.sort_values('DT_OPEN')
           .groupby('CLI_ID')
           .first()
           .reset_index()
           .loc[lambda x: (x['DT_OPEN'] >= START_DATE) & (x['DT_OPEN'] <= END_DATE)])
first['month'] = first['DT_OPEN'].dt.to_period('M')
first['group'] = first['PROD_NAME'].apply(lambda x: '–§–£' if x in FU_PRODUCTS else '–ë–∞–Ω–∫')

# === –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –º–µ—Å—è—Ü—ã ===
months = pd.period_range('2024-01', '2025-06', freq='M')
rows = []

for m in months:
    month_end = m.end_time.normalize()

    # –Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
    cohort = first.loc[first['month'] == m]
    cli_ids = set(cohort['CLI_ID'])

    if not cli_ids:
        rows.append([month_end.strftime('%d.%m.%Y'), 0, 0, 0.0, 0.0])
        continue

    # –≤–∫–ª–∞–¥—ã —ç—Ç–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –∏ –∂–∏–≤—ã–µ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞
    df_m = df[
        df['CLI_ID'].isin(cli_ids) &
        (df['DT_OPEN'].dt.to_period('M') == m) &
        (df['DT_OPEN'] <= month_end) &
        ((df['DT_CLOSE'].isna()) | (df['DT_CLOSE'] > month_end)) &
        (df['BALANCE_RUB'].fillna(0) >= MIN_BAL_RUB)
    ].copy()

    df_m['vol_fu']  = df_m['BALANCE_RUB'].where(df_m['is_fu'], 0)
    df_m['vol_nb']  = df_m['BALANCE_RUB'].where(~df_m['is_fu'], 0)

    # —Å–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª–∏–µ–Ω—Ç—É
    g = df_m.groupby('CLI_ID')[['vol_fu', 'vol_nb']].sum().reset_index()
    g = g.merge(cohort[['CLI_ID', 'group']], on='CLI_ID', how='left')

    # —Å—á–∏—Ç–∞–µ–º
    n_fu     = (g['group'] == '–§–£').sum()
    n_bank   = (g['group'] == '–ë–∞–Ω–∫').sum()
    vol_fu   = g.loc[g['group'] == '–§–£',   'vol_fu'].sum()
    vol_bank = g.loc[g['group'] == '–ë–∞–Ω–∫', 'vol_nb'].sum()

    rows.append([month_end.strftime('%d.%m.%Y'), n_fu, n_bank, vol_fu, vol_bank])

# === –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ ===
res_df = pd.DataFrame(rows, columns=[
    '–ú–µ—Å—è—Ü',
    '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å –§–£',
    '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ë–∞–Ω–∫–∞',
    '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£',
    '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞'
])
res_df.set_index('–ú–µ—Å—è—Ü', inplace=True)

# === –í—ã–≤–æ–¥ –≤ –≤–∏–¥–µ –∫–∞–∫ —É —Ç–µ–±—è ‚Äî —Å—Ç—Ä–æ–∫–∏: –º–µ—Ç—Ä–∏–∫–∏, —Å—Ç–æ–ª–±—Ü—ã: –º–µ—Å—è—Ü—ã ===
final = res_df.T
final.columns.name = None
print(final)


‚∏ª

üìå –õ–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:

–≠—Ç–∞–ø	–û–ø–∏—Å–∞–Ω–∏–µ
–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç	CLI_ID, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä–≤—ã–π –≤–∫–ª–∞–¥ –æ—Ç–∫—Ä—ã—Ç –≤ –¥–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ
–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞	–ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –≤–∫–ª–∞–¥ ‚Äî –≤ FU_PRODUCTS, —Ç–æ —ç—Ç–æ ‚Äú–§–£‚Äù, –∏–Ω–∞—á–µ ‚Äî ‚Äú–ë–∞–Ω–∫‚Äù
–û–±—ä—ë–º	–ë–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∫–ª–∞–¥—ã, –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ, –∏ –∂–∏–≤—ã–µ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞ (DT_CLOSE > –º–µ—Å—è—Ü_–∫–æ–Ω–µ—Ü)
–ü–æ–ª–µ —Å—É–º–º—ã	–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è BALANCE_RUB, –Ω–µ OUT_RUB
–§–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥	–°—Ç—Ä–æ–∫–∏: —Ç–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π, —Å—Ç–æ–ª–±—Ü—ã ‚Äî –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ 31.01.2024, 29.02.2024 –∏ —Ç.–¥.


‚∏ª

–•–æ—á–µ—à—å —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel –∏–ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é ‚Äî –Ω–∞–ø–∏—à–∏. –í—Å—ë –æ—Ç–ª–∞–∂–µ–Ω–æ.
