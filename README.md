–æ—Ç–ª–∏—á–Ω–æ üí° ‚Äî —Ç—ã —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–µ—Ä–µ–¥ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–º —à–∞–≥ 1:
—Ä–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (EDA / step 0.5), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Ä—Ç—Ñ–µ–ª—è –¥–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –æ–±—Ä–µ–∑–æ–∫.

–¥–∞–≤–∞–π —è –ø—Ä–µ–¥–ª–æ–∂—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π step 0.5 ‚Äî ‚ÄúExploratory analysis & portfolio structure‚Äù,
–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–≥—Ä—É–∑–∫–∏ (–ø–æ—Å–ª–µ step 0).

‚∏ª

üîç Step 0.5 ‚Äî —Ä–∞–∑–≤–µ–¥–∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (EDA)

–¶–µ–ª—å:
–ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å—Ç–∏–º—É–ª—ã, –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ CPR, –∫–∞–∫–∏–µ –æ–±—ä—ë–º—ã –∏ –¥–æ–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã,
–∏ –∫–∞–∫ —ç—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –º–µ—Å—è—Ü–∞–º (payment_period).

‚∏ª

üì¶ –ß—Ç–æ —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç

1Ô∏è‚É£ Excel-–æ—Ç—á—ë—Ç eda_summary.xlsx, —Å–æ –≤–∫–ª–∞–¥–∫–∞–º–∏:

Sheet	–û–ø–∏—Å–∞–Ω–∏–µ
overview_by_age_stim	–ø–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º: LoanAge √ó Stimulus —Å —Å—É–º–º–∞–º–∏ OD_AFTER_PLAN, PREMAT_PAYMENT, CPR, –¥–æ–ª—è–º–∏
overview_lastN_periods	—Ç–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –¥–ª—è N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–µ–≤ (–ø–æ payment_period)
summary_period_dynamics	–¥–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π: –∫–∞–∫ –º–µ–Ω—è—é—Ç—Å—è –¥–æ–ª–∏ –ø–æ —Å—Ç–∏–º—É–ª–∞–º –∏ age
histograms_data	–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π CPR, —Å—Ç–∏–º—É–ª–æ–≤ –∏ –æ–±—ä—ë–º–æ–≤

–ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤–∫–ª—é—á–∞–µ—Ç:
	‚Ä¢	LoanAge, Stimulus, sum_od, share_od, sum_premat, share_premat,
CPR, count_con, mean_rate, payment_period (–µ—Å–ª–∏ –µ—Å—Ç—å).

‚∏ª

üìä –ì—Ä–∞—Ñ–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è:

–ì—Ä–∞—Ñ–∏–∫	–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç	–§–∞–π–ª
üìà Stimulus Distribution.png	—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ (OD) –ø–æ —Å—Ç–∏–º—É–ª–∞–º, –æ–±—â–∏–π –∏ –≤ –¥–æ–ª—è—Ö	charts/stimulus_dist.png
üìä AgeGroup Volume.png	–≤–∫–ª–∞–¥ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø –≤ –æ–±—â–∏–π OD –∏ Premat	charts/agegroup_volumes.png
üß© CPR_Hist.png	—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPR –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º	charts/cpr_hist.png
üîÅ Stimulus_Dynamics.png	—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–º—É–ª–æ–≤ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º N –º–µ—Å—è—Ü–∞–º (stacked bars)	charts/stimulus_dynamics.png
üïí CPR_Dynamics.png	—Å—Ä–µ–¥–Ω–∏–π CPR –ø–æ –º–µ—Å—è—Ü–∞–º (payment_period)	charts/cpr_dynamics.png


‚∏ª

‚öôÔ∏è –õ–æ–≥–∏–∫–∞ –∫–æ–¥–∞

# -*- coding: utf-8 -*-
"""
STEP 0.5 ‚Äî Exploratory Data Analysis before step 1.
–°–æ–∑–¥–∞—ë—Ç Excel + –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø–æ age_group, —Å—Ç–∏–º—É–ª—É, CPR –∏ –¥–∏–Ω–∞–º–∏–∫–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.
"""

import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
from dateutil.relativedelta import relativedelta
import warnings

warnings.filterwarnings("ignore", category=FutureWarning)
plt.rcParams["axes.formatter.useoffset"] = False

def _ensure_dir(p): os.makedirs(p, exist_ok=True); return p

def run_step05_exploratory(
    df_raw_program: pd.DataFrame,
    out_root: str = r"C:\Users\mi.makhmudov\Desktop\SCurve_step05",
    program_name: str = "UNKNOWN",
    last_months: int = 3
):
    out_dir = _ensure_dir(os.path.join(out_root, datetime.now().strftime("%Y-%m-%d_%H-%M-%S")))
    charts_dir = _ensure_dir(os.path.join(out_dir, "charts"))

    df = df_raw_program.copy()
    df["payment_period"] = pd.to_datetime(df["payment_period"])
    df["age_group_id"] = pd.to_numeric(df["age_group_id"], errors="coerce").astype("Int64")
    df["stimul"] = pd.to_numeric(df["stimul"], errors="coerce")
    df["od_after_plan"] = pd.to_numeric(df["od_after_plan"], errors="coerce")
    df["premat_payment"] = pd.to_numeric(df["premat_payment"], errors="coerce")

    df = df[df["od_after_plan"]>0]
    df["CPR"] = 1 - np.power(1 - df["premat_payment"]/df["od_after_plan"], 12)
    df["CPR"] = df["CPR"].clip(0, 1)

    # === overview by age √ó stimul ===
    agg_all = df.groupby(["age_group_id","stimul"], as_index=False).agg(
        sum_od=("od_after_plan","sum"),
        sum_premat=("premat_payment","sum"),
        count_con=("con_id","count")
    )
    agg_all["CPR"] = np.where(agg_all["sum_od"]>0,
                              1 - np.power(1 - agg_all["sum_premat"]/agg_all["sum_od"],12), np.nan)
    total_od = agg_all["sum_od"].sum()
    total_premat = agg_all["sum_premat"].sum()
    agg_all["share_od"] = agg_all["sum_od"]/total_od
    agg_all["share_premat"] = agg_all["sum_premat"]/total_premat

    # === –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤ ===
    max_p = df["payment_period"].max()
    min_p = max_p - relativedelta(months=last_months-1)
    df_recent = df[df["payment_period"].between(min_p, max_p)]
    agg_recent = df_recent.groupby(["payment_period","age_group_id","stimul"], as_index=False).agg(
        sum_od=("od_after_plan","sum"),
        sum_premat=("premat_payment","sum")
    )
    agg_recent["CPR"] = np.where(agg_recent["sum_od"]>0,
                                 1 - np.power(1 - agg_recent["sum_premat"]/agg_recent["sum_od"],12), np.nan)

    # === –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ CPR ===
    dyn = df.groupby("payment_period", as_index=False).agg(
        CPR_mean=("CPR","mean"),
        sum_od=("od_after_plan","sum")
    )

    # === —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Excel ===
    with pd.ExcelWriter(os.path.join(out_dir,"eda_summary.xlsx"), engine="openpyxl") as xw:
        agg_all.to_excel(xw, sheet_name="overview_by_age_stim", index=False)
        agg_recent.to_excel(xw, sheet_name="overview_lastN_periods", index=False)
        dyn.to_excel(xw, sheet_name="CPR_dynamics", index=False)

    # === –≥—Ä–∞—Ñ–∏–∫–∏ ===
    # 1) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–º—É–ª–æ–≤ –ø–æ –æ–±—ä—ë–º—É
    fig, ax = plt.subplots(figsize=(9,5))
    bins = np.linspace(df["stimul"].min(), df["stimul"].max(), 40)
    ax.hist(df["stimul"], bins=bins, weights=df["od_after_plan"]/1e9,
            color="#1f77b4", alpha=0.7, edgecolor="none")
    ax.set_xlabel("Incentive, –ø.–ø."); ax.set_ylabel("–û–±—ä—ë–º, –º–ª—Ä–¥ —Ä—É–±")
    ax.set_title(f"{program_name}: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–º—É–ª–æ–≤ –ø–æ –æ–±—ä—ë–º—É (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ)")
    fig.tight_layout(); fig.savefig(os.path.join(charts_dir,"stimulus_dist.png"), dpi=220); plt.close(fig)

    # 2) –æ–±—ä—ë–º—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
    fig, ax = plt.subplots(figsize=(8,5))
    vol_by_age = agg_all.groupby("age_group_id")[["sum_od","sum_premat"]].sum()/1e9
    vol_by_age.plot(kind="bar", ax=ax)
    ax.set_title(f"{program_name}: –æ–±—ä—ë–º—ã OD –∏ Premat –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–º")
    ax.set_xlabel("Age group"); ax.set_ylabel("–º–ª—Ä–¥ —Ä—É–±")
    fig.tight_layout(); fig.savefig(os.path.join(charts_dir,"agegroup_volumes.png"), dpi=220); plt.close(fig)

    # 3) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPR
    fig, ax = plt.subplots(figsize=(8,5))
    ax.hist(df["CPR"], bins=40, color="#ff7f0e", alpha=0.6)
    ax.set_title(f"{program_name}: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPR –ø–æ –≤—Å–µ–º –¥–æ–≥–æ–≤–æ—Ä–∞–º")
    ax.set_xlabel("CPR (–¥–æ–ª—è/–≥–æ–¥)"); ax.set_ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ")
    fig.tight_layout(); fig.savefig(os.path.join(charts_dir,"cpr_hist.png"), dpi=220); plt.close(fig)

    # 4) –¥–∏–Ω–∞–º–∏–∫–∞ CPR –ø–æ –º–µ—Å—è—Ü–∞–º
    fig, ax = plt.subplots(figsize=(9,5))
    dyn["month_label"] = dyn["payment_period"].dt.strftime("%B %Y").str.capitalize()
    ax.plot(dyn["month_label"], dyn["CPR_mean"], "-o", color="#2ca02c")
    ax.set_title(f"{program_name}: —Å—Ä–µ–¥–Ω–∏–π CPR –ø–æ –º–µ—Å—è—Ü–∞–º")
    ax.grid(ls="--", alpha=0.3)
    plt.xticks(rotation=45, ha="right")
    fig.tight_layout(); fig.savefig(os.path.join(charts_dir,"cpr_dynamics.png"), dpi=220); plt.close(fig)

    print(f"\n‚úÖ STEP 0.5 –≥–æ—Ç–æ–≤–æ –¥–ª—è {program_name}")
    print(f"‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã: {min_p.date()}‚Äì{max_p.date()}")
    print(f"‚Ä¢ –ü–∞–ø–∫–∞: {out_dir}")
    return {"output_dir": out_dir, "agg_all": agg_all, "agg_recent": agg_recent, "dyn": dyn}


‚∏ª

üìà –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞

res05 = run_step05_exploratory(
    df_raw_program=df_raw_program,
    out_root=r"C:\Users\mi.makhmudov\Desktop\SCurve_step05",
    program_name="–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
    last_months=4
)


‚∏ª

üí° –ò–¥–µ–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
	‚Ä¢	–¥–æ–±–∞–≤–∏—Ç—å heatmap (seaborn.heatmap) –ø–æ LoanAge √ó Stimulus ‚Äî –æ—Ç—Ç–µ–Ω–∫–∏ = –æ–±—ä—ë–º/–¥–æ–ª—è;
	‚Ä¢	–¥–æ–±–∞–≤–∏—Ç—å scatter CPR vs Stimulus (–≤–∑–≤–µ—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä–æ–º OD);
	‚Ä¢	–¥–∏–Ω–∞–º–∏–∫–∞ CPR –ø–æ age_group –Ω–∞ –æ–¥–Ω–æ–º –≥—Ä–∞—Ñ–∏–∫–µ (stacked lines);
	‚Ä¢	–µ—Å–ª–∏ —É–∫–∞–∂–µ—à—å compare=True, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É —Å—Ç—Ä–æ–∏—Ç—å ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤ vs –≤—Å—ë –≤—Ä–µ–º—è¬ª.

‚∏ª

–•–æ—á–µ—à—å, —è –¥–æ–±–∞–≤–ª—é heatmap —Å –æ–±—ä—ë–º–∞–º–∏ (LoanAge √ó Stimulus, —Ü–≤–µ—Ç = –ª–æ–≥(OD)) –∏/–∏–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CPR –ø–æ age-–≥—Ä—É–ø–ø–∞–º (boxplot)?
