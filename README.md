##############################################################################
# 0.  ИСХОДНЫЕ ДАННЫЕ  –  rates_df  (Date, Bank, Currency, Term, Rate)       #
##############################################################################
#  • Date      – datetime64[ns]                                              #
#  • Currency  – "Рубли"  (интересуют только рубли)                          #
#  • Term      – срок в днях (int)                                           #
#  • Rate      – ставка (float)                                              #

banks_target = ['Банк ДОМ.РФ', 'ТОП-10 Средняя ставка']
curr_target  = 'Рубли'

##############################################################################
# 1.  MAX ставка «до 1 года»  (Term ≤ 365)                                   #
##############################################################################
max_rows = (
    rates_df
      .query('Bank in @banks_target and Currency == @curr_target and Term <= 365')
      .groupby(['Date','Bank','Currency'], as_index=False)         # внутри банка/даты
      .agg(Rate=('Rate','max'))
      .assign(Term='максимальная ставка до 1 года')                # строковый term
)

##############################################################################
# 2.  MEAN ставка «до 1 года»                                               #
##############################################################################
mean_rows = (
    rates_df
      .query('Bank in @banks_target and Currency == @curr_target and Term <= 365')
      .groupby(['Date','Bank','Currency'], as_index=False)
      .agg(Rate=('Rate','mean'))
      .assign(Term='среднее арифметическое ставок до 1 года')
)

##############################################################################
# 3.  ДОБАВЛЯЕМ в исходный rates_df  (при желании)                           #
##############################################################################
rates_aug = pd.concat([rates_df, max_rows, mean_rows], ignore_index=True)

# теперь в rates_aug есть дополнительные строки:
#   • Bank = 'Банк ДОМ.РФ', Term = 'максимальная ставка до 1 года',  Rate = max…
#   • Bank = 'ТОП-10 Средняя ставка', Term = 'максимальная ставка до 1 года'
#   • аналогично для «среднее арифметическое …»
#
# Если нужен отдельный DataFrame — используйте max_rows / mean_rows по‑отдельности.


```python
##############################################################################
# 0.  ИСХОДНЫЕ ДАННЫЕ  –  rates_df  (Date, Bank, Currency, Term, Rate)       #
##############################################################################
#  • Date      – datetime64[ns]                                              #
#  • Currency  – "Рубли"  (интересуют только рубли)                          #
#  • Term      – срок в днях (int)                                           #
#  • Rate      – ставка (float)                                              #

banks_target = ['Банк ДОМ.РФ', 'ТОП-10 Средняя ставка']
curr_target  = 'Рубли'

##############################################################################
# 1.  MAX ставка «до 1 года»  (Term ≤ 365)                                   #
##############################################################################
max_rows = (
    rates_df
      .query('Bank in @banks_target and Currency == @curr_target and Term <= 365')
      .groupby(['Date','Bank','Currency'], as_index=False)         # внутри банка/даты
      .agg(Rate=('Rate','max'))
      .assign(Term='максимальная ставка до 1 года')                # строковый term
)

##############################################################################
# 2.  MEAN ставка «до 1 года»                                               #
##############################################################################
mean_rows = (
    rates_df
      .query('Bank in @banks_target and Currency == @curr_target and Term <= 365')
      .groupby(['Date','Bank','Currency'], as_index=False)
      .agg(Rate=('Rate','mean'))
      .assign(Term='среднее арифметическое ставок до 1 года')
)

##############################################################################
# 3.  ДОБАВЛЯЕМ в исходный rates_df  (при желании)                           #
##############################################################################
rates_aug = pd.concat([rates_df, max_rows, mean_rows], ignore_index=True)

# теперь в rates_aug есть дополнительные строки:
#   • Bank = 'Банк ДОМ.РФ', Term = 'максимальная ставка до 1 года',  Rate = max…
#   • Bank = 'ТОП-10 Средняя ставка', Term = 'максимальная ставка до 1 года'
#   • аналогично для «среднее арифметическое …»
#
# Если нужен отдельный DataFrame — используйте max_rows / mean_rows по‑отдельности.
```

```python
##############################################################################
# 0.  ИСХОДНЫЙ ДФ  –  rates_aug  (уже содержит «max» и «mean» строки)        #
##############################################################################
#  нужные банки, валюта, интересующие Term‑ы
banks_pair = ['Банк ДОМ.РФ', 'ТОП-10 Средняя ставка']
terms_keep = [90, 180, 270, 365,
              'максимальная ставка до 1 года',
              'среднее арифметическое ставок до 1 года']

sub = (rates_aug
       .query('Currency == "Рубли" and Bank in @banks_pair and Term in @terms_keep')
       .copy())

##############################################################################
# 1.  раздвигаем по двум столбцам «Dom» и «Top10»                             #
##############################################################################
dom = (sub[sub['Bank'] == 'Банк ДОМ.РФ']
        .rename(columns={'Rate': 'Rate_Dom'})
        [['Date','Term','Rate_Dom']])

top = (sub[sub['Bank'] == 'ТОП-10 Средняя ставка']
        .rename(columns={'Rate': 'Rate_Top'})
        [['Date','Term','Rate_Top']])

pair = (dom
        .merge(top, on=['Date','Term'], how='inner')      # берём только даты, когда есть оба
        .assign(Rate_Diff=lambda d: d['Rate_Dom'] - d['Rate_Top']))

##############################################################################
# 2.  оформляем итоговый DataFrame                                            #
##############################################################################
rate_diff_df = (pair[['Date','Term','Rate_Diff']]
                .assign(Currency='Рубли',
                        Bank='разница ставок ДОМА - Средняя ставка по рынку')
                .rename(columns={'Rate_Diff':'Rate'})
                .sort_values(['Date','Term'])
                .reset_index(drop=True))

# --- итог ---
display(rate_diff_df.head())

# если нужно сохранить в Excel / CSV
# rate_diff_df.to_excel('dom_vs_market_premium.xlsx', index=False)
```

**Что делает код**

1. **Фильтр** `Currency=='Рубли'`, два нужных банка и шесть интересующих `Term`.  
2. **`merge` по `Date` + `Term`** — получаем пары став‑ка Дом.РФ / средняя Top‑10.  
3. **`Rate_Diff = Dom − Top10`**.  
4. Формируем итоговую таблицу с колонками:  

| Date | Currency | Bank | Term | Rate |
|------|----------|------|------|------|
| 2024‑05‑01 | Рубли | разница ставок ДОМА ‑ Средняя ставка по рынку | 90 | 0.0025 |
| … | … | … | … | … |

Теперь `rate_diff_df` можно напрямую соединять с дневными потоками, чтобы оценивать чувствительность притока/оттока к премии по каждой категории Term.
