–ù–∏–∂–µ ‚Äï –≥–æ—Ç–æ–≤—ã–µ —è—á–µ–π–∫–∏ **—à–∞–≥ 2 +** –¥–ª—è –≤–∞—à–µ–≥–æ –Ω–æ—É—Ç–±—É–∫–∞.
–û–Ω–∏:

* —Å—Ç—Ä–æ—è—Ç —Å—Ç–æ–ª–±—á–∞—Ç—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã ¬´–°—É–º–º–∞¬ª –∏ `margin` (–°—Ä–æ—á–Ω—ã–µ vs –ù–°);
* —Å—Ç—Ä–æ—è—Ç scatter *margin vs –°—É–º–º–∞*;
* —Ä–∏—Å—É—é—Ç **–∫–∞—Ä—Ç—É –†–§** –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —à–µ–π–ø-—Ñ–∞–π–ª–æ–≤ ‚Äï –±–µ—Ä—ë–º –≥—Ä–∞–Ω–∏—Ü—É —Å—Ç—Ä–∞–Ω—ã –∏–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ *Natural Earth*, –∞ –≥–æ—Ä–æ–¥–∞ –Ω–∞–Ω–æ—Å–∏–º –ø–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–±–∏—Ç—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –±–ª–æ–∫–∏ **–ø–æ—Å–ª–µ** —è—á–µ–π–∫–∏, –≥–¥–µ –≤—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ `df`.

---

```python
# %% 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
from pathlib import Path
import matplotlib.pyplot as plt
import geopandas as gpd
from shapely.geometry import Point

OUTDIR = Path("outputs")
OUTDIR.mkdir(exist_ok=True)

# üìå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–ª–∞–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ / —Ä–µ–≥–∏–æ–Ω–æ–≤
CITY_COORDS = {
    "–º–æ—Å–∫–≤–∞":          (55.7558, 37.6176),
    "–¥—á–±–æ":            (55.7558, 37.6176),   # –µ—Å–ª–∏ —ç—Ç–æ –ú–æ—Å–∫–≤–∞-–æ—Ñ–∏—Å, –ø–æ–ø—Ä–∞–≤—å—Ç–µ
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9311, 30.3609),
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä":       (45.0355, 38.9753),
    "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥": (56.3269, 44.0059),
    "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É":  (47.2357, 39.7015),
    "—Å–∞–º–∞—Ä–∞":          (53.1959, 50.1008),
    "–ø–µ–Ω–∑–∞":           (53.1959, 45.0180),
    "—É—Ñ–∞":             (54.7388, 55.9721),
    "–≤–æ—Ä–æ–Ω–µ–∂":         (51.6608, 39.2003),
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥":    (56.8389, 60.6057),
    "—á–µ–ª—è–±–∏–Ω—Å–∫":       (55.1644, 61.4368),
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫":     (55.0084, 82.9357),
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫":      (56.0153, 92.8932),
    "–∫–∞–∑–∞–Ω—å":          (55.7961, 49.1064),
    "–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥":     (54.7104, 20.4522),
    "—Ç—é–º–µ–Ω—å":          (57.1530, 65.5343),
    "—Ç–≤–µ—Ä—å":           (56.8587, 35.9176),
    "–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫":     (43.1155, 131.8855),
    "—Ç—É–ª–∞":            (54.1960, 37.6182),
    "—Å–∞—Ä–∞—Ç–æ–≤":         (51.5331, 46.0342),
    "–ø–µ—Ä–º—å":           (58.0105, 56.2502),
    "–∏—Ä–∫—É—Ç—Å–∫":         (52.2869, 104.3050),
}

def _canonical(name: str) -> str:
    """–ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã."""
    return name.strip().lower()

def bar_compare(df, value_col, filename):
    pivot = (df.pivot_table(index="region", columns="section",
                            values=value_col, aggfunc="sum")
               .fillna(0)
               .loc[lambda x: x.sum(axis=1).sort_values(ascending=False).index])  # –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    ax = pivot.plot(kind="bar", figsize=(15, 6), edgecolor="black")
    ax.set_title(f"{value_col} by region")
    ax.set_ylabel(value_col)
    plt.xticks(rotation=45, ha="right")
    plt.tight_layout()
    plt.savefig(OUTDIR / filename, dpi=300)
    plt.show()

def scatter_margin_vs_sum(df, filename):
    fig, ax = plt.subplots(figsize=(8, 6))
    for section, grp in df.groupby("section"):
        ax.scatter(grp["sum"], grp["margin"], label=section, s=70, alpha=0.75)
    ax.set_xlabel("Sum (thousand RUB)")
    ax.set_ylabel("Margin")
    ax.set_title("Margin vs Volume")
    ax.legend(title="Product")
    plt.tight_layout()
    plt.savefig(OUTDIR / filename, dpi=300)
    plt.show()

def russia_base():
    """–≥—Ä–∞–Ω–∏—Ü–∞ –†–§ –∏–∑ NaturalEarth (–≤—Ö–æ–¥–∏—Ç –≤ geopandas)."""
    world = gpd.read_file(gpd.datasets.get_path("naturalearth_lowres"))
    russia = world.query("name == 'Russia'")
    return russia.to_crs(3857)   # Web-Mercator –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

def bubble_map(df, value_col, section, filename):
    ru = russia_base()
    # —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç
    data = df[df.section == section].copy()
    # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    lats, lons, vals = [], [], []
    for _, row in data.iterrows():
        key = _canonical(row["region"])
        if key not in CITY_COORDS:
            continue
        lat, lon = CITY_COORDS[key]
        lats.append(lat)
        lons.append(lon)
        vals.append(row[value_col])
    cities = gpd.GeoDataFrame(
        {"value": vals},
        geometry=gpd.points_from_xy(lons, lats),
        crs="EPSG:4326",
    ).to_crs(3857)

    # —Ä–∏—Å—É–µ–º
    ax = ru.plot(figsize=(10, 7), color="#f0f0f0", edgecolor="#666")
    # —Ä–∞–¥–∏—É—Å –ø—É–∑—ã—Ä–µ–π –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª–µ–Ω –∫–æ—Ä–Ω—é –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è
    sizes = (cities["value"] / cities["value"].max()) ** 0.5 * 15000
    cities.plot(ax=ax, markersize=sizes, alpha=0.7, color="#d62728")
    ax.set_axis_off()
    ax.set_title(f"{section}: {value_col} by city (bubbles)")
    plt.tight_layout()
    plt.savefig(OUTDIR / filename, dpi=300)
    plt.show()
```

```python
# %% 3Ô∏è‚É£ –°—Ç–æ–ª–±—á–∞—Ç—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
bar_compare(df, "sum",    "sum_bar.png")
bar_compare(df, "margin", "margin_bar.png")
```

```python
# %% 4Ô∏è‚É£ Scatter margin vs sum
scatter_margin_vs_sum(df, "scatter_margin_vs_sum.png")
```

```python
# %% 5Ô∏è‚É£ –ö–∞—Ä—Ç—ã-–ø—É–∑—ã—Ä—å–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
for sec in df["section"].unique():
    bubble_map(df, "sum", sec, f"{sec}_sum_map.png")
```

---

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å / –ø–æ—á–µ–º—É —ç—Ç–æ ¬´–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ¬ª

| –ë—ã–ª–æ                                  | –°—Ç–∞–ª–æ                                                                                  |
| ------------------------------------- | -------------------------------------------------------------------------------------- |
| –¢—Ä–µ–±–æ–≤–∞–ª –≤–Ω–µ—à–Ω–∏–π —à–µ–π–ø-—Ñ–∞–π–ª            | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É –†–§ *(Natural Earth)*, –∑–Ω–∞—á–∏—Ç *–Ω–∏—á–µ–≥–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –Ω–µ –Ω–∞–¥–æ*. |
| –û—à–∏–±–∫–∞, –µ—Å–ª–∏ ¬´margin¬ª –Ω–∞–∑—ã–≤–∞–ª—Å—è –∏–Ω–∞—á–µ | –í—ã —É–∂–µ –ø–æ—á–∏–Ω–∏–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ —á—Ç–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫.                                               |
| –ö–∞—Ä—Ç–∞ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏–≥–æ–Ω—ã | –î–µ–ª–∞–µ—Ç—Å—è ¬´—Ç–µ–ø–ª–æ–≤–∞—è¬ª –∫–∞—Ä—Ç–∞ –ø—É–∑—ã—Ä—å–∫–∞–º–∏-–ø–æ-–≥–æ—Ä–æ–¥–∞–º (–Ω–∞–≥–ª—è–¥–Ω–æ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).         |
| –í—ã–≤–æ–¥ –≤ `outputs/`                    | –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä—è–¥–æ–º —Å –Ω–æ—É—Ç–±—É–∫–æ–º.                                       |

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ ‚Äí PNG-—Ñ–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –≤ `outputs`, –∞ –≥—Ä–∞—Ñ–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –ø—Ä—è–º–æ –≤ –Ω–æ—É—Ç–±—É–∫–µ.

–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –≤–º–µ—Å—Ç–æ –ø—É–∑—ã—Ä–µ–π –≤—Å—ë-—Ç–∞–∫–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ö–æ—Ä–æ–ø–ª–µ—Ç –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º, —Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ–π–ø-—Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, **gadm41\_RUS\_1.shp**). –í –æ—Å—Ç–∞–ª—å–Ω–æ–º –∫–æ–¥ —É–∂–µ –≥–æ—Ç–æ–≤.

–î–∞–π—Ç–µ –∑–Ω–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏, –∏–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞ –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∏!
