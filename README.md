–í–æ—Ç —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–∏—Ç —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ –º–µ—Å—è—Ü–∞–º —Å —è–Ω–≤–∞—Ä—è 2024 –ø–æ –∏—é–Ω—å 2025. –û–Ω —Å—á–∏—Ç–∞–µ—Ç:
	‚Ä¢	–°–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏—à–ª–∏ —á–µ—Ä–µ–∑ –§–£ –∏ —Å–∫–æ–ª—å–∫–æ –Ω–µ —á–µ—Ä–µ–∑ –§–£ (–≤–ø–µ—Ä–≤—ã–µ –æ—Ç–∫—Ä—ã–ª–∏ –≤–∫–ª–∞–¥ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü).
	‚Ä¢	–ö–∞–∫–æ–π —Å—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å (OUT_RUB) –Ω–∞ –¥–∞—Ç—É SNAP_DATE –æ—Å—Ç–∞–ª—Å—è —É —ç—Ç–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.

import pandas as pd

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
FU_PRODUCTS = {
    '–ù–∞–¥—ë–∂–Ω—ã–π','–ù–∞–¥—ë–∂–Ω—ã–π VIP','–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
    '–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ','–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
    '–ù–∞–¥—ë–∂–Ω—ã–π T2','–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
}
SNAP_DATE   = pd.Timestamp('2025-06-30')
MIN_BAL_RUB = 1.0

# === –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –¥–∞—Ç ===
df = df_sql.copy()
for c in ['DT_OPEN', 'DT_CLOSE']:
    df[c] = pd.to_datetime(df[c], errors='coerce')

df = df[~((df['DT_CLOSE'].notna()) & ((df['DT_CLOSE'] - df['DT_OPEN']).dt.days <= 2))].copy()
df['is_fu'] = df['PROD_NAME'].isin(FU_PRODUCTS)

# === –ü–µ—Ä–≤—ã–π –≤–∫–ª–∞–¥ –∫–ª–∏–µ–Ω—Ç–∞ ===
first_open = df.sort_values('DT_OPEN').groupby('CLI_ID').first()
first_open = first_open.loc[(first_open['DT_OPEN'] >= '2024-01-01') & (first_open['DT_OPEN'] <= SNAP_DATE)].copy()

# === –ü–æ–º–µ—Å—è—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è ===
first_open['Month'] = first_open['DT_OPEN'].dt.to_period('M')

# === –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤: –Ω–æ–≤—ã–π —Å –§–£ / –Ω–µ —Å –§–£ ===
first_open['group'] = first_open['PROD_NAME'].apply(lambda x: '–§–£' if x in FU_PRODUCTS else '–ë–∞–Ω–∫')

# === –ñ–∏–≤–æ–π –±–∞–ª–∞–Ω—Å –Ω–∞ –¥–∞—Ç—É SNAP_DATE ===
live = df.loc[
    (df['DT_OPEN'] <= SNAP_DATE) &
    ((df['DT_CLOSE'].isna()) | (df['DT_CLOSE'] > SNAP_DATE)) &
    (df['OUT_RUB'].fillna(0) >= MIN_BAL_RUB)
].copy()

live['is_fu']  = live['PROD_NAME'].isin(FU_PRODUCTS)
live['vol_fu'] = live['OUT_RUB'].where(live['is_fu'], 0)
live['vol_nb'] = live['OUT_RUB'].where(~live['is_fu'], 0)

agg_bal = (
    live.groupby('CLI_ID')[['vol_fu', 'vol_nb']].sum()
)

# === –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–æ–π ===
first_open = first_open.join(agg_bal, on='CLI_ID')
first_open = first_open.fillna({'vol_fu': 0.0, 'vol_nb': 0.0})

# === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ===
def summarize(df, group_label):
    g = df[df['group'] == group_label].groupby('Month').agg(
        –ö–ª–∏–µ–Ω—Ç–æ–≤=('CLI_ID', 'count'),
        –ü–æ—Ä—Ç—Ñ–µ–ª—å=('vol_fu' if group_label == '–§–£' else 'vol_nb', 'sum')
    )
    g.index = g.index.astype(str)
    return g

fu_summary   = summarize(first_open, '–§–£')
bank_summary = summarize(first_open, '–ë–∞–Ω–∫')

# === –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É ===
result = pd.concat([
    fu_summary.rename(columns={'–ö–ª–∏–µ–Ω—Ç–æ–≤': '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å –§–£', '–ü–æ—Ä—Ç—Ñ–µ–ª—å': '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£'}),
    bank_summary.rename(columns={'–ö–ª–∏–µ–Ω—Ç–æ–≤': '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ë–∞–Ω–∫–∞', '–ü–æ—Ä—Ç—Ñ–µ–ª—å': '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞'})
], axis=1).fillna(0).astype({'–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å –§–£': int, '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ë–∞–Ω–∫–∞': int})

# === –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–º —Å—Ç–æ–ª–±—Ü—ã ===
result = result[
    ['–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å –§–£', '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ë–∞–Ω–∫–∞',
     '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£', '–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞']
]

# === –¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∫ —É —Ç–µ–±—è ===
final = result.T
final.columns.name = None  # —É–±–∏—Ä–∞–µ–º –∏–º—è —Å—Ç–æ–ª–±—Ü–∞
print(final)

üìå –ü–æ–ª—É—á–∏—à—å —Ç–∞–±–ª–∏—á–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ ‚Äî –º–µ—Å—è—Ü–∞–º–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM) –∏ —Å—Ç—Ä–æ–∫–∞–º–∏:
	‚Ä¢	–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å –§–£
	‚Ä¢	–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ë–∞–Ω–∫–∞
	‚Ä¢	–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –§–£
	‚Ä¢	–ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –º–µ—Å—è—Ü—ã –±—ã–ª–∏ –≤ –≤–∏–¥–µ 31.01.2024, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å:

final.columns = [pd.Period(m).end_time.strftime('%d.%m.%Y') for m in final.columns]

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –≤ Excel, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏–ª–∏ —Ä–∞–∑–±–∏—Ç—å –ø–æ –≥–æ–¥–∞–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏.
