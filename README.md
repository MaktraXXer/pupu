

–°–æ–≥–ª–∞—Å–µ–Ω, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω—É–∂–Ω—ã. –í–æ—Ç —Ç–æ—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, —á—Ç–æ–±—ã **–∞–≥—Ä–µ–≥–∞—Ü–∏—è —à–ª–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º —Å —á–µ—Ç–≤–µ—Ä–≥–∞ –ø–æ —Å—Ä–µ–¥—É**.

---

### üîß –ß—Ç–æ –∑–∞–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ:

–ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫:

```python
data['week_start'] = data['dt_rep'].dt.to_period('W').apply(lambda p: p.start_time)
data['week_end']   = data['week_start'] + pd.Timedelta(days=6)
```

–Ω–∞ **–≤–æ—Ç —ç—Ç–æ—Ç –∫–æ–¥**, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–≤–∏–≥–∞–µ—Ç –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ –Ω–∞ —á–µ—Ç–≤–µ—Ä–≥:

```python
# –ù–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —á–µ—Ç–≤–µ—Ä–≥–∞, –ø–æ—ç—Ç–æ–º—É –æ—Ç–Ω–∏–º–∞–µ–º 3 –¥–Ω—è (—á—Ç–æ–±—ã —á–µ—Ç–≤–µ—Ä–≥ —Å—Ç–∞–ª "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–æ–º")
data['week_start'] = data['dt_rep'] - pd.to_timedelta((data['dt_rep'].dt.weekday - 3) % 7, unit='d')
data['week_end']   = data['week_start'] + pd.Timedelta(days=6)
```

---

### üéØ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:

* `data['dt_rep'].dt.weekday` –≤—ã–¥–∞—ë—Ç –Ω–æ–º–µ—Ä –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (0 ‚Äî –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6 ‚Äî –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ).
* `(weekday - 3) % 7` ‚Äî —Å–¥–≤–∏–≥–∞–µ—Ç —Ç–∞–∫, —á—Ç–æ–±—ã **—á–µ—Ç–≤–µ—Ä–≥ —Å—Ç–∞–ª ¬´–Ω—É–ª–µ–≤—ã–º¬ª –¥–Ω—ë–º**.
* –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –Ω–µ–¥–µ–ª—è –±—É–¥–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å **—á–µ—Ç–≤–µ—Ä–≥–∞** –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è **—Å—Ä–µ–¥–æ–π**.

---

### üí° –û—Å—Ç–∞–ª—å–Ω–æ–µ –≤ –∫–æ–¥–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```python
data['–ù–µ–¥–µ–ª—è'] = (data['week_start'].dt.day.astype(str).str.zfill(2) + '-' +
                  data['week_end'].dt.day.astype(str).str.zfill(2)   + ' ' +
                  data['week_end'].dt.month.map(lambda m: RU_MON[m-1]))
```

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –≤—ã–≤–µ–¥—É —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –≤—Å–µ–≥–æ –∫–æ–¥–∞ —Å —ç—Ç–∏–º –∫—É—Å–∫–æ–º —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º.



–ù–∏–∂–µ ‚Äï ¬´–∑–∞–≥–æ—Ç–æ–≤–∫–∞¬ª –Ω–∞ pandas, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è –≤–∞—à—É –ª–æ–≥–∏–∫—É, —Ç–æ–ª—å–∫–æ –≤–º–µ—Å—Ç–æ –∫–æ–ª–æ–Ω–∫–∏ **—Å–∞–ª—å–¥–æ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
`NET_SUM_TRANS_total`, –∞ –Ω—É–∂–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∑–∞–¥–∞–Ω—ã —Ä–æ–≤–Ω–æ —Ç–∞–∫, –∫–∞–∫ –≤—ã –æ–ø–∏—Å–∞–ª–∏.

```python
import numpy as np
import pandas as pd
import math, re

###############################################################################
# 0.  –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äï DataFrame `df` (–ø—Ä–æ—á–∏—Ç–∞–ª–∏ CSV / Excel –∏ —Ç.–¥.)
###############################################################################
# df = pd.read_excel('raw.xlsx', parse_dates=['dt_rep'])   # –ø—Ä–∏–º–µ—Ä —á—Ç–µ–Ω–∏—è

###############################################################################
# 1.  –§–∏–ª—å—Ç—Ä: direction_type = ¬´–ü–µ—Ä–µ–≤–æ–¥—ã —Å–µ–±–µ¬ª  –∏  partner_code = '-'
#     –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (¬´(–í—Å–µ)¬ª) –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
###############################################################################
flt = (
    (df['direction_type'] == '–ü–µ—Ä–µ–≤–æ–¥—ã —Å–µ–±–µ')
    & (df['partner_code']   == '-')
)
data = df.loc[flt].copy()

###############################################################################
# 2.  –ù–µ–¥–µ–ª—è ‚Äí —É–¥–æ–±–Ω–∞—è ¬´—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è¬ª –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–¥‚Äì–¥–¥ –ú–ú–ú
#     (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ rep_W, –µ—Å–ª–∏ –æ–Ω –≤–∞—Å —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç)
###############################################################################
# –µ—Å–ª–∏ –≤ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–µ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ rep_W –≤–∏–¥–∞ '2025.01.16-2025.01.22',
# —Ç–æ –ø—Ä–æ—Å—Ç–æ:  data['–ù–µ–¥–µ–ª—è'] = data['rep_W']
# –ù–∏–∂–µ ‚Äí –≤–∞—Ä–∏–∞–Ω—Ç ¬´–æ—Ç –¥–∞—Ç—ã¬ª:
data['week_start'] = data['dt_rep'].dt.to_period('W').apply(lambda p: p.start_time)
data['week_end']   = data['week_start'] + pd.Timedelta(days=6)
RU_MON = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω',
          '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫']
data['–ù–µ–¥–µ–ª—è'] = (data['week_start'].dt.day.astype(str).str.zfill(2) + '-' +
                  data['week_end'].dt.day.astype(str).str.zfill(2)   + ' ' +
                  data['week_end'].dt.month.map(lambda m: RU_MON[m-1]))

###############################################################################
# 3.  –°—á–∏—Ç–∞–µ–º –Ω–µ–¥–µ–ª—å–Ω–æ–µ —Å–∞–ª—å–¥–æ –ø–æ –∫–∞–∂–¥–æ–º—É –±–∞–Ω–∫—É
###############################################################################
wb = (data
      .groupby(['–ù–µ–¥–µ–ª—è', 'bank_name_main'], as_index=False)['NET_SUM_TRANS_total']
      .sum()
      .rename(columns={'NET_SUM_TRANS_total': '—Å–∞–ª—å–¥–æ'}))

###############################################################################
# 4.  ¬´–ó–∞–º–µ—Ç–Ω—ã–µ¬ª –±–∞–Ω–∫–∏  ‚Äî —Ç–µ, —É –∫–æ–≥–æ |—Å–∞–ª—å–¥–æ| ‚â• THR —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑.
#     –ü–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100 –º–ª–Ω).
###############################################################################
THR = 1e8                # 100 000 000
wb['sal_big'] = wb['—Å–∞–ª—å–¥–æ'].where(wb['—Å–∞–ª—å–¥–æ'].abs() >= THR, np.nan)
BANKS_BIG = wb.loc[wb['sal_big'].notna(), 'bank_name_main'].unique()

###############################################################################
# 5.  –ü–∏–≤–æ—Ç: –Ω–µ–¥–µ–ª–∏ √ó –±–∞–Ω–∫–∏-¬´–∑–≤—ë–∑–¥—ã¬ª, –∑–Ω–∞—á–µ–Ω–∏–µ = sal_big (–∏–Ω–∞—á–µ NaN)
###############################################################################
pivot = (wb[wb['bank_name_main'].isin(BANKS_BIG)]
         .pivot(index='–ù–µ–¥–µ–ª—è',
                columns='bank_name_main',
                values='sal_big')
         .sort_index())

###############################################################################
# 6.  –ö–æ–ª–æ–Ω–∫–∞ ¬´–û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏¬ª = –æ–±—â–µ–µ –Ω–µ–¥–µ–ª—å–Ω–æ–µ —Å–∞–ª—å–¥–æ ‚àí —Å—É–º–º–∞ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω–Ω—ã—Ö
###############################################################################
total_week = wb.groupby('–ù–µ–¥–µ–ª—è')['—Å–∞–ª—å–¥–æ'].sum()
pivot['–û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏'] = total_week - pivot.fillna(0).sum(axis=1)

###############################################################################
# 7.  –ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏–º: –ø–µ—Ä–µ–≤–æ–¥ –≤ –º–ª—Ä–¥ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏, NaN –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
###############################################################################
pivot_fmt = pivot.applymap(
    lambda x: np.nan if pd.isna(x) else round(x/1e6, 2)   # ‚Üí –º–ª–Ω; –ø–æ–º–µ–Ω—è–π—Ç–µ /1e9 –¥–ª—è –º–ª—Ä–¥
)

pd.set_option('display.max_columns', None)
print('\n=== –°–∞–ª—å–¥–æ (|‚â•100 –º–ª–Ω|) –ø–æ –Ω–µ–¥–µ–ª—è–º, –º–ª–Ω —Ä—É–±. ===')
print(pivot_fmt.to_string())
pd.reset_option('display.max_columns')

###############################################################################
# 8.  –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel / CSV
###############################################################################
pivot_fmt.to_excel('—Å–∞–ª—å–¥–æ_–ø–æ_–±–∞–Ω–∫–∞–º_–Ω–µ–¥–µ–ª–∏.xlsx')
# pivot_fmt.to_csv('—Å–∞–ª—å–¥–æ_–ø–æ_–±–∞–Ω–∫–∞–º_–Ω–µ–¥–µ–ª–∏.csv')
```

### –ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å

| –ü–∞—Ä–∞–º–µ—Ç—Ä          | –ó–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç              | –¢–∏–ø–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ                                  |
| ----------------- | ---------------------------- | --------------------------------------------------- |
| `THR`             | –ø–æ—Ä–æ–≥ ¬´–∑–∞–º–µ—Ç–Ω–æ—Å—Ç–∏¬ª –±–∞–Ω–∫–∞     | `1.5e8`, `5e7`, `0` (–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö)                 |
| `–ù–µ–¥–µ–ª—è`          | –º–µ—Ç–∫–∞ –ø–µ—Ä–∏–æ–¥–∞                | –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `data['rep_W']`, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞ |
| `round(x/1e6, 2)` | –ø–µ—Ä–µ–≤–æ–¥ –≤ –º–ª–Ω –∏ —á–∏—Å–ª–æ –∑–Ω–∞–∫–æ–≤ | `/1e9` ‚Üí –º–ª—Ä–¥, `3` ‚Üí —Ç—Ä–∏ –∑–Ω–∞–∫–∞                      |

–ö–æ–¥ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫–∞–∫ –µ—Å—Ç—å: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –∏–º—è –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞ `df`, –µ—Å–ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–æ–µ, –∏ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ / —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.




```python
import pandas as pd
import numpy as np

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ DataFrame df)
# df = pd.read_excel('–≤–∞—à–∏_–¥–∞–Ω–Ω—ã–µ.xlsx')

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
filtered = df[
    (df['direction_type'] == '–ü–µ—Ä–µ–≤–æ–¥—ã —Å–µ–±–µ') &
    (df['partner_code'] == '-')
]

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–µ–¥–µ–ª–µ –∏ –±–∞–Ω–∫—É —Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–∞–ª—å–¥–æ
grouped = filtered.groupby(['rep_W', 'bank_name_main'], as_index=False)['NET_SUM_TRANS_total'].sum()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤ —Å –±–æ–ª—å—à–∏–º —Å–∞–ª—å–¥–æ (–ø–æ—Ä–æ–≥ 100 –º–ª–Ω)
THR = 100_000_000
bank_max = grouped.groupby('bank_name_main')['NET_SUM_TRANS_total'].apply(lambda x: x.abs().max())
BANKS_BIG = bank_max[bank_max >= THR].index.tolist()

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏ –º–µ—Ç–∫–∏ –Ω–µ–¥–µ–ª–∏
grouped[['start_str', 'end_str']] = grouped['rep_W'].str.split('-', expand=True)
grouped['w_end'] = pd.to_datetime(grouped['end_str'], format='%Y.%m.%d')
RU_MON = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫']
grouped['–ù–µ–¥–µ–ª—è'] = grouped['w_end'].apply(lambda x: f"{x.day:02d}-{(x + pd.DateOffset(days=6)).day:02d} {RU_MON[x.month-1]}")

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∞–ª—å–¥–æ
grouped['saldo_filtered'] = np.where(
    (grouped['bank_name_main'].isin(BANKS_BIG)) & 
    (grouped['NET_SUM_TRANS_total'].abs() >= THR),
    grouped['NET_SUM_TRANS_total'],
    np.nan
)

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
pivot = grouped.pivot(index='–ù–µ–¥–µ–ª—è', columns='bank_name_main', values='saldo_filtered')

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ "–û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏"
total_per_week = grouped.groupby('–ù–µ–¥–µ–ª—è')['NET_SUM_TRANS_total'].sum()
pivot['–û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏'] = total_per_week - pivot.fillna(0).sum(axis=1)

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
pivot_formatted = pivot.applymap(lambda x: f"{round(x/1e6, 2)}M" if pd.notnull(x) else np.nan)
pivot_formatted.to_excel('—Å–∞–ª—å–¥–æ_–ø–æ_–Ω–µ–¥–µ–ª—è–º_–∏_–±–∞–Ω–∫–∞–º.xlsx')

print("–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª '—Å–∞–ª—å–¥–æ_–ø–æ_–Ω–µ–¥–µ–ª—è–º_–∏_–±–∞–Ω–∫–∞–º.xlsx'")
``` 

–≠—Ç–æ—Ç –∫–æ–¥:
1. –§–∏–ª—å—Ç—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º
2. –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–∞–ª—å–¥–æ –ø–æ –Ω–µ–¥–µ–ª—è–º –∏ –±–∞–Ω–∫–∞–º
3. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–Ω–∫–∏ —Å –±–æ–ª—å—à–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
4. –°–æ–∑–¥–∞–µ—Ç —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–µ–ª—å
5. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —Å –Ω–∞–Ω–æ–º –¥–ª—è –º–∞–ª—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
6. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Excel —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö
