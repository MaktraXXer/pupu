### –ö–æ—Ä–æ—Ç–∫–æ

* **–õ–æ–≥–∏–∫–∞ –æ–±–æ–∏—Ö –æ—Ç—á—ë—Ç-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞** ‚Äì –º–µ–Ω—è—Ç—å —Ä–∞—Å—á—ë—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –Ω–µ –Ω—É–∂–Ω–æ.
* –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ `fu_vintage_results_ext` –∏–º—è –ø–æ–ª—è ‚Äì **`had_deposit_before`** (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤). –í —Å–∫—Ä–∏–ø—Ç–µ ‚Ññ 2 –æ–Ω–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí –æ–∫.
* –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å** –≤ –¥–≤—É—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö ‚Äì ¬´–∂—ë—Å—Ç–∫–∏–π¬ª –ø–µ—Ä–µ—á–µ–Ω—å Main-–≤–∫–ª–∞–¥–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å *–ù–∞–¥—ë–∂–Ω—ã–π –¢2* –∏ *–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω*).
  –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å, —Ç–æ —Å—Ç—Ä–æ–∫–∏ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –±—É–¥—É—Ç –ø–æ—Å—á–∏—Ç–∞–Ω—ã –∫–∞–∫ ¬´–Ω–µ –Ω–∞ –§–£¬ª.

–ù–∏–∂–µ ‚Äì –æ–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ä–∞–±–æ—á–µ–º –≤–∏–¥–µ —É–∂–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º Main-–ø—Ä–æ–¥—É–∫—Ç–æ–≤.
–ù–∞–∑–≤–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.

---

## üìÑ –°–∫—Ä–∏–ø—Ç 1‚ÄÉ¬´FU ONLY / –Ω–µ FU / –¢–æ—Ç–∞–ª¬ª

```sql
/* 0. –ë–∞–∑–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ */
WITH base AS (
    SELECT dt_rep,
           cli_id,
           fu_only_overall,        -- 0 / 1
           prod_name_res,
           sum_out_rub
    FROM alm_test.dbo.fu_vintage_results_ext WITH (NOLOCK)
),

/* 1. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ 0-/1-–∫–ª–∏–µ–Ω—Ç–æ–≤ */
grouped AS (
    SELECT
        dt_rep,
        fu_only_overall,

        /* ‚îÄ‚îÄ‚îÄ –æ–±—ä—ë–º—ã ‚îÄ‚îÄ‚îÄ */
        SUM(CASE WHEN prod_name_res IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN sum_out_rub ELSE 0 END)               AS [–û–±—ä–µ–º –Ω–∞ –§–£, —Ä—É–±.],

        SUM(CASE WHEN prod_name_res NOT IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN sum_out_rub ELSE 0 END)               AS [–û–±—ä–µ–º –Ω–µ –Ω–∞ –§–£, —Ä—É–±.],

        SUM(sum_out_rub)                             AS [–û–±—ä–µ–º –≤—Å–µ–≥–æ, —Ä—É–±.],

        /* ‚îÄ‚îÄ‚îÄ –∫–ª–∏–µ–Ω—Ç—ã ‚îÄ‚îÄ‚îÄ */
        COUNT(DISTINCT CASE WHEN prod_name_res IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN cli_id END)                           AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –§–£],

        COUNT(DISTINCT CASE WHEN prod_name_res NOT IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN cli_id END)                           AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞ –§–£],

        COUNT(DISTINCT cli_id)                       AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–æ]
    FROM base
    GROUP BY dt_rep, fu_only_overall
),

/* 2. –¢–æ—Ç–∞–ª (fu_only_overall = 2) */
totals AS (
    SELECT
        dt_rep,
        2 AS fu_only_overall,
        [–û–±—ä–µ–º –Ω–∞ –§–£, —Ä—É–±.],
        [–û–±—ä–µ–º –Ω–µ –Ω–∞ –§–£, —Ä—É–±.],
        [–û–±—ä–µ–º –≤—Å–µ–≥–æ, —Ä—É–±.],
        [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –§–£],
        [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞ –§–£],
        [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–æ]
    FROM grouped
    GROUP BY dt_rep
)

/* 3. –ò—Ç–æ–≥–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ */
SELECT
    dt_rep,
    CASE fu_only_overall
        WHEN 1 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∏ –≤–∫–ª–∞–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –§–£'
        WHEN 0 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –ë–∞–Ω–∫–∞'
        WHEN 2 THEN N'–¢–æ—Ç–∞–ª'
    END                                   AS [–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤],
    [–û–±—ä–µ–º –Ω–∞ –§–£, —Ä—É–±.],
    [–û–±—ä–µ–º –Ω–µ –Ω–∞ –§–£, —Ä—É–±.],
    [–û–±—ä–µ–º –≤—Å–µ–≥–æ, —Ä—É–±.],
    [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –§–£],
    [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞ –§–£],
    [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–æ]
FROM (
    SELECT * FROM grouped
    UNION ALL
    SELECT * FROM totals
) fin
ORDER BY dt_rep, [–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤];
```

---

## üìÑ –°–∫—Ä–∏–ø—Ç 2‚ÄÉ¬´FU ONLY √ó HAD BEFORE¬ª

```sql
/* 0. –ë–∞–∑–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ */
WITH base AS (
    SELECT dt_rep,
           cli_id,
           fu_only_overall,        -- 0 / 1
           had_deposit_before,     -- 0 / 1
           prod_name_res,
           sum_out_rub
    FROM alm_test.dbo.fu_vintage_results_ext WITH (NOLOCK)
),

/* 1. –ü–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ 0/1 √ó 0/1 */
core AS (
    SELECT
        dt_rep,
        fu_only_overall,
        had_deposit_before,

        /* ‚îÄ‚îÄ‚îÄ –æ–±—ä—ë–º—ã ‚îÄ‚îÄ‚îÄ */
        SUM(CASE WHEN prod_name_res IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN sum_out_rub ELSE 0 END)               AS vol_fu,

        SUM(CASE WHEN prod_name_res NOT IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN sum_out_rub ELSE 0 END)               AS vol_non_fu,

        SUM(sum_out_rub)                             AS vol_total,

        /* ‚îÄ‚îÄ‚îÄ –∫–ª–∏–µ–Ω—Ç—ã ‚îÄ‚îÄ‚îÄ */
        COUNT(DISTINCT CASE WHEN prod_name_res IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN cli_id END)                           AS cli_fu,

        COUNT(DISTINCT CASE WHEN prod_name_res NOT IN (
            N'–ù–∞–¥—ë–∂–Ω—ã–π',N'–ù–∞–¥—ë–∂–Ω—ã–π VIP',N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–µ–º–∏—É–º',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –ø—Ä–æ–º–æ',N'–ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç',
            N'–ù–∞–¥—ë–∂–Ω—ã–π –¢2',N'–ù–∞–¥—ë–∂–Ω—ã–π –ú–µ–≥–∞—Ñ–æ–Ω'
        ) THEN cli_id END)                           AS cli_non_fu,

        COUNT(DISTINCT cli_id)                       AS cli_total
    FROM base
    GROUP BY dt_rep, fu_only_overall, had_deposit_before
),

/* 2. –¢–æ—Ç–∞–ª—ã */
tot_fu_only AS (         -- fu_only_overall = 2
    SELECT
        dt_rep,
        2 AS fu_only_overall,
        had_deposit_before,
        SUM(vol_fu)     AS vol_fu,
        SUM(vol_non_fu) AS vol_non_fu,
        SUM(vol_total)  AS vol_total,
        SUM(cli_fu)     AS cli_fu,
        SUM(cli_non_fu) AS cli_non_fu,
        SUM(cli_total)  AS cli_total
    FROM core
    GROUP BY dt_rep, had_deposit_before
),
tot_had_before AS (      -- had_deposit_before = 2
    SELECT
        dt_rep,
        fu_only_overall,
        2 AS had_deposit_before,
        SUM(vol_fu)     AS vol_fu,
        SUM(vol_non_fu) AS vol_non_fu,
        SUM(vol_total)  AS vol_total,
        SUM(cli_fu)     AS cli_fu,
        SUM(cli_non_fu) AS cli_non_fu,
        SUM(cli_total)  AS cli_total
    FROM core
    GROUP BY dt_rep, fu_only_overall
),
tot_tot AS (             -- 2 √ó 2
    SELECT
        dt_rep,
        2 AS fu_only_overall,
        2 AS had_deposit_before,
        SUM(vol_fu)     AS vol_fu,
        SUM(vol_non_fu) AS vol_non_fu,
        SUM(vol_total)  AS vol_total,
        SUM(cli_fu)     AS cli_fu,
        SUM(cli_non_fu) AS cli_non_fu,
        SUM(cli_total)  AS cli_total
    FROM core
    GROUP BY dt_rep
)

/* 3. –ò—Ç–æ–≥–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ */
SELECT
    dt_rep,
    CASE fu_only_overall
        WHEN 0 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –ë–∞–Ω–∫–∞'
        WHEN 1 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∏ –≤–∫–ª–∞–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –§–£'
        WHEN 2 THEN N'–¢–æ—Ç–∞–ª –ø–æ FU_ONLY'
    END                                   AS –ö–∞—Ç–µ–≥–æ—Ä–∏—è_FU_ONLY,

    CASE had_deposit_before
        WHEN 0 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –±—ã–ª–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ë–∞–Ω–∫–∞ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ –§–£'
        WHEN 1 THEN N'–£ –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –ë–∞–Ω–∫–∞ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ –§–£'
        WHEN 2 THEN N'–¢–æ—Ç–∞–ª –ø–æ HAD_BEFORE'
    END                                   AS –ö–∞—Ç–µ–≥–æ—Ä–∏—è_HAD_BEFORE,

    vol_fu      AS [–û–±—ä–µ–º –Ω–∞ –§–£, —Ä—É–±.],
    vol_non_fu  AS [–û–±—ä–µ–º –Ω–µ –Ω–∞ –§–£, —Ä—É–±.],
    vol_total   AS [–û–±—ä–µ–º –≤—Å–µ–≥–æ, —Ä—É–±.],

    cli_fu      AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –§–£],
    cli_non_fu  AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞ –§–£],
    cli_total   AS [–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–æ]

FROM (
    SELECT * FROM core
    UNION ALL
    SELECT * FROM tot_fu_only
    UNION ALL
    SELECT * FROM tot_had_before
    UNION ALL
    SELECT * FROM tot_tot
) fin
ORDER BY dt_rep, –ö–∞—Ç–µ–≥–æ—Ä–∏—è_FU_ONLY, –ö–∞—Ç–µ–≥–æ—Ä–∏—è_HAD_BEFORE;
```

### –ß—Ç–æ –µ—â—ë –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

* –°–∫—Ä–∏–ø—Ç—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ —Ç–æ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞-–∏—Å—Ç–æ—á–Ω–∏–∫ **—É–∂–µ** –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π `COALESCE` (—á—Ç–æ–±—ã `fu_only_*` –∏ `had_deposit_before` –±—ã–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤–µ—Ä–Ω–æ).
* –ï—Å–ª–∏ –≤—ã —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É –≤ –¥—Ä—É–≥–æ–º —Å—Ö–µ–º–µ/–∏–º–µ–Ω–∏ ‚Äì –ø–æ–ø—Ä–∞–≤—å—Ç–µ `FROM ‚Ä¶ fu_vintage_results_ext`.
* –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö Main-–≤–∫–ª–∞–¥–æ–≤ –≤ –±—É–¥—É—â–µ–º ‚Äì –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–ø–∏—Å–æ–∫ –≤ –æ–±–æ–∏—Ö –æ—Ç—á—ë—Ç–∞—Ö.

–ü–æ—Å–ª–µ —ç—Ç–æ–π –ø—Ä–∞–≤–∫–∏ –æ–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫ –∏ –¥–∞—é—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.
