### Обновлённый скрипт ― только русские названия столбцов

Ниже представление **WORK.vSpread\_TR\_OIS\_UL\_5d**, которое:

* использует исключительно **те имена колонок, которые уже заданы в вашей витрине** (русские + пробелы);
* считает
  – дневной объём (млн руб),
  – **“Средневзвешенный по срочности спред ТС к OIS”** на каждую дату,
  – 5-дневное среднее этого спреда,
  – сумму объёмов за 5 дней;
* показывает только **5 последних рабочих дат** (без `ORDER BY`-в финале ― он запрещён в представлениях).

```sql
USE ALM_TEST;
GO
/*--------------------------------------------------------------
  0.  Чистим предыдущую версию (если была)
--------------------------------------------------------------*/
IF OBJECT_ID('WORK.vSpread_TR_OIS_UL_5d', 'V') IS NOT NULL
    DROP VIEW WORK.vSpread_TR_OIS_UL_5d;
GO

SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;
GO
/*--------------------------------------------------------------
  1.  Создаём новое представление
--------------------------------------------------------------*/
CREATE VIEW WORK.vSpread_TR_OIS_UL_5d
AS
/*-- 1.1  Отбор сделок под условия ТЗ --------------------------------------*/
WITH base AS (
    SELECT
        g.[Date],                                                                  -- дата
        g.[Рабочий Spread_TransfertRate_x_OIS на объем и срочность] AS Num,        -- числитель
        g.[BALANCE_MILLION на срочность]                           AS Den,        -- знаменатель
        g.[BALANCE_MILLION]                                         AS VolMln      -- «чистый» объём (млн)
    FROM WORK.vGroupDepositInterestsRate_dtStart_UL_matur_pdr_fo g WITH (NOLOCK)
    WHERE g.[Тип клиента]      = 'ЮЛ'
      AND g.[Сегмент бизнеса]  = 'all segment'
      AND g.[Тип отчета]       = 'Начало день ко дню'
      AND g.[IS_FINANCE_LCR]   = 'all FINANCE_LCR'
      AND g.[IS_PDR]           = 'all PDR'
      AND g.[Срочн. бакеты]   <> 'all termgroup'
      AND g.[MATUR]            <= 30
),
/*-- 1.2  Агрегируем по каждой дате ----------------------------------------*/
daily AS (
    SELECT
        b.[Date],
        /* дневной объём (млн) */
        СуммаОбъёмов_млн = CAST(SUM(b.VolMln) AS DECIMAL(18,4)),
        /* средневзвешенный по объёму×срочности спред */
        СредневзвСпредТС_OIS = CAST(
            SUM(b.Num) / NULLIF(SUM(b.Den),0)
            AS DECIMAL(18,8))
    FROM base b
    GROUP BY b.[Date]
),
/*-- 1.3  Нумеруем даты от самой свежей ------------------------------------*/
ranked AS (
    SELECT  d.*,
            rn = ROW_NUMBER() OVER (ORDER BY d.[Date] DESC)
    FROM    daily d
),
/*-- 1.4  Берём 5 последних рабочих дат ------------------------------------*/
last5 AS (
    SELECT * FROM ranked WHERE rn <= 5
),
/*-- 1.5  5-дневные агрегаты -----------------------------------------------*/
agg5 AS (
    SELECT
        СредневзвСпредТС_OIS_5д = CAST(AVG(СредневзвСпредТС_OIS) AS DECIMAL(18,8)),
        СуммаОбъёмов_5д_млн     = SUM(СуммаОбъёмов_млн)
    FROM last5
)
/*-- 1.6  Итоговый вывод ----------------------------------------------------*/
SELECT
    l.[Date]                                                         AS [Дата],
    l.СуммаОбъёмов_млн                                               AS [Объём, млн],
    l.СредневзвСпредТС_OIS                                           AS [Средневзв. спред ТС-OIS],
    a.СредневзвСпредТС_OIS_5д                                        AS [Средневзв. спред ТС-OIS, 5д],
    a.СуммаОбъёмов_5д_млн                                            AS [Сумма объёмов 5д, млн]
FROM last5 l
CROSS JOIN agg5 a;       -- средняк и сумма одинаковы для всех 5 строк
GO
```

#### Что вы получаете

| Колонка в результате            | Содержание                                                                              |
| ------------------------------- | --------------------------------------------------------------------------------------- |
| **Дата**                        | Рабочая дата сделки                                                                     |
| **Объём, млн**                  | Совокупный объём новых сделок ЮЛ на эту дату (млн руб)                                  |
| **Средневзв. спред ТС-OIS**     | Средневзвешенный (по объёму × срочности) спред «ТС\* – OIS» именно за эту дату          |
| **Средневзв. спред ТС-OIS, 5д** | То же, усреднённое по последним пяти рабочим датам (в каждой строке одно и то же число) |
| **Сумма объёмов 5д, млн**       | Сумма объёмов за те же 5 дат                                                            |

> **Важно:** представление само не сортирует строки.
> Если в запросе нужен порядок, просто добавьте:
>
> ```sql
> SELECT * FROM WORK.vSpread_TR_OIS_UL_5д
> ORDER BY [Дата];
> ```

Таким образом, все расчёты делаются внутри SQL-сервера, **только на базе русских имён столбцов**, а Excel остаётся для визуализации, если она потребуется. Если нужно что-то поправить или добавить — пишите!
