`@AnchorFact` и другие переменные действительно **должны быть объявлены раньше, чем они впервые встречаются в тексте**.
Из-за того, что в предыдущей версии мы инициализировали `@LastSnapDate` сразу после объявления, а в выражении использовали ещё «пустой» `@AnchorFact`, компилятор ругнулся.
Лечится просто: сначала объявляем все переменные, потом задаём им значения.

Ниже ― **единственный исправленный блок** (остальной текст процедуры менять не нужно).

```sql
/*--------------------------------------------------------------------
  0. опорные даты и «таблица чисел»
--------------------------------------------------------------------*/
DECLARE
    @AnchorFact   date ,                     -- задаём позже через SELECT
    @ScenCutOff   date = '2026-08-16',       -- день перед след. заседанием
    @LastSnapDate date ,                     -- задаём после AnchorFact
    @HistoryCut   date = @HistoryCut,        -- виден во всей процедуре
    @HorizonDays  int  = @HorizonDays;       --     »»

-- получили дату последнего фактического снап-шота
SELECT @AnchorFact = MAX(DT_REP)
FROM   ALM.info.VW_ForecastKEY_interval;

-- теперь можно посчитать хвост
SET @LastSnapDate = DATEADD(day, @HorizonDays, @AnchorFact);
```

### Куда вставить

1. Сразу после строки
   `SET NOCOUNT ON;`
2. Удалите старый блок с `DECLARE … @AnchorFact …` и `SET @LastSnapDate …` ― чтобы не было дубликатов.

После этой правки процедура создаётся и выполняется без компиляционных ошибок.

> **Проверка**

```sql
EXEC dbo.usp_BuildKeyCache @Scenario = 1;

-- исторический день: должен совпасть с витриной
SELECT TOP (10) *
FROM   WORK.ForecastKey_Cache_Scen
WHERE  SCENARIO = 1 AND DT_REP = '2025-07-01'
ORDER  BY TERM;

-- переходный день: ставка должна стать 0.18 (18 %) 28-го июля
SELECT *
FROM   WORK.ForecastKey_Cache_Scen
WHERE  SCENARIO = 1 AND DT_REP = '2025-07-24'
ORDER  BY TERM;
```

Если всё в порядке:

* для `2025-07-01` строки идут с `2025-07-01`, ставка 0.20 до 27-го,
  с 28-го ― 0.18, `TERM` = 1, 2, …;
* для `2025-07-24` ― 24-27-е 0.20, 28-е 0.18.

Аналогично запускаем для сценариев 2 и 3.
