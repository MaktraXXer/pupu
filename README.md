### Скрипт-обновление WORK.vSpread\_TR\_OIS\_UL\_5d

(баланс — в рублях, последние 5 рабочих дат, конкретные бакеты срочности)

```sql
USE ALM_TEST;
GO
/*--------------------------------------------------------------
0.  Удаляем старую версию представления, если она была
--------------------------------------------------------------*/
IF OBJECT_ID('WORK.vSpread_TR_OIS_UL_5d', 'V') IS NOT NULL
    DROP VIEW WORK.vSpread_TR_OIS_UL_5d;
GO

SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;
GO
/*--------------------------------------------------------------
1.  Создаём новую витрину
--------------------------------------------------------------*/
CREATE VIEW WORK.vSpread_TR_OIS_UL_5d
AS
/*-- 1.1  Берём нужные сделки из исходной витрины -------------------------*/
WITH base AS (
    SELECT
        g.[Date],                                                                 -- дата
        g.[Рабочий Spread_TransfertRate_x_OIS на объем и срочность]  AS Num,      -- числитель
        g.[BALANCE_MILLION на срочность]                           AS Den,       -- знаменатель
        g.[BALANCE_RUB]                                            AS BalanceRUB -- баланс руб.
    FROM WORK.vGroupDepositInterestsRate_dtStart_UL_matur_pdr_fo g  WITH (NOLOCK)
    /* фильтры ТЗ */
    INNER JOIN ALM.info.VW_calendar cal                -- гарантия «рабочего» дня
           ON g.[Date] = cal.[Date] AND cal.IsWorkDay = 1
    WHERE g.[Тип клиента]      = 'ЮЛ'
      AND g.[Сегмент бизнеса]  = 'all segment'
      AND g.[Тип отчета]       = 'Начало день ко дню'
      AND g.[IS_FINANCE_LCR]   = 'all FINANCE_LCR'
      AND g.[IS_PDR]           = 'all PDR'
      AND g.[Срочн. бакеты]   IN ( N'1', N'2-6', N'7-13', N'14-20', N'21-29' )
),
/*-- 1.2  Агрегация по каждой дате ----------------------------------------*/
daily AS (
    SELECT
        b.[Date],
        -- баланс за дату, рубли без округления
        Баланс_руб           = SUM(b.BalanceRUB),
        -- средневзв. спред (по объёму × срочности)
        Средневзв_спред_TC_OIS = CAST(
            SUM(b.Num) / NULLIF(SUM(b.Den),0)
            AS DECIMAL(18,8))
    FROM base b
    GROUP BY b.[Date]
),
/*-- 1.3  Нумеруем даты от самой свежей -----------------------------------*/
ranked AS (
    SELECT  d.*,
            rn = ROW_NUMBER() OVER (ORDER BY d.[Date] DESC)
    FROM    daily d
),
/*-- 1.4  Оставляем пять последних рабочих дат ----------------------------*/
last5 AS (
    SELECT * FROM ranked WHERE rn <= 5
),
/*-- 1.5  5-дневные агрегаты ----------------------------------------------*/
agg5 AS (
    SELECT
        Средневзв_спред_TC_OIS_5д = CAST(AVG(Средневзв_спред_TC_OIS) AS DECIMAL(18,8)),
        Сумма_балансов_5д_руб     = SUM(Баланс_руб)
    FROM last5
)
/*-- 1.6  Итоговый селект --------------------------------------------------*/
SELECT
    l.[Date]                                   AS [Дата],
    l.Баланс_руб                               AS [Баланс, руб],
    l.Средневзв_спред_TC_OIS                   AS [Средневзв. спред ТС-OIS],
    a.Средневзв_спред_TC_OIS_5д                AS [Средневзв. спред ТС-OIS, 5д],
    a.Сумма_балансов_5д_руб                    AS [Сумма балансов 5д, руб]
FROM last5 l
CROSS JOIN agg5 a;        -- одинаковое 5-дневное среднее и объём для всех 5 строк
GO
```

#### Что изменилось

| Требование                     | Реализация                                                                                         |
| ------------------------------ | -------------------------------------------------------------------------------------------------- |
| **1. Баланс в рублях**         | Колонка **\[Баланс, руб]** выводит `SUM([BALANCE_RUB])` — без деления на 100 000 и без округления. |
| **2. Последние 5 рабочих дат** | `INNER JOIN ALM.info.VW_calendar` → `IsWorkDay = 1`, затем `ROW_NUMBER()` → `rn <= 5`.             |
| **3. Только нужные бакеты**    | `WHERE [Срочн. бакеты] IN ('1','2-6','7-13','14-20','21-29')`.                                     |

> **Использование**
> Если нужен единичный результат только за самую свежую дату, выполните:
>
> ```sql
> SELECT TOP (1) *
> FROM WORK.vSpread_TR_OIS_UL_5d
> ORDER BY [Дата] DESC;
> ```
>
> Порядок строк в представлении не гарантирован, поэтому внешним запросом всегда добавляйте `ORDER BY [Дата]`, когда это важно.

Сообщите, если требуется ещё что-нибудь изменить!
